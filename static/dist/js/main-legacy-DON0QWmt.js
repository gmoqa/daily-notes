System.register([],function(e,t){"use strict";return{execute:function(){const e=new class{_state;_listeners;_computed;constructor(){this._state={currentUser:null,userSettings:{theme:"dark",weekStart:0,timezone:"UTC",dateFormat:"DD-MM-YY",uniqueContextMode:!1,showBreadcrumb:!1,showMarkdownEditor:!1,hideNewContextButton:!1},selectedContext:null,selectedDate:null,contexts:[],notes:[],notesWithDates:[],currentCalendarMonth:(new Date).getMonth(),currentCalendarYear:(new Date).getFullYear(),isLoggingOut:!1,syncStatus:{pending:0,syncing:!1},serverTimeOffset:0},this._listeners=new Map,this._computed=new Map}get(e){return this._computed.has(e)?this._computed.get(e)(this._state):this._state[e]}set(e,t){const n=this._state[e];n!==t&&(this._state[e]=t,this._notify(e,t,n))}update(e){Object.entries(e).forEach(([e,t])=>{this.set(e,t)})}subscribe(e,t){return this._listeners.has(e)||this._listeners.set(e,new Set),this._listeners.get(e).add(t),()=>{const n=this._listeners.get(e);n&&n.delete(t)}}subscribeMany(e,t){const n=e.map(e=>this.subscribe(e,t));return()=>n.forEach(e=>e())}computed(e,t){this._computed.set(e,t)}getState(){return{...this._state}}_notify(e,t,n){const s=this._listeners.get(e);s&&s.forEach(e=>{try{e(t,n)}catch(s){}});const o=this._listeners.get("*");o&&o.forEach(s=>{try{s(e,t,n)}catch(o){}})}};e.computed("today",e=>{const t=e.userSettings.timezone||"UTC",n=new Date(Date.now()+e.serverTimeOffset),s=new Intl.DateTimeFormat("en-US",{timeZone:t,year:"numeric",month:"2-digit",day:"2-digit"}).formatToParts(n);return`${s.find(e=>"year"===e.type).value}-${s.find(e=>"month"===e.type).value}-${s.find(e=>"day"===e.type).value}`}),"undefined"!=typeof window&&(window.__STATE__=e);const t=new class{db=null;dbName="DailyNotesDB";version=1;pendingWrites=new Map;writeTimer=null;BATCH_DELAY=500;async init(){return new Promise((e,t)=>{const n=indexedDB.open(this.dbName,this.version);n.onerror=()=>t(n.error),n.onsuccess=()=>{this.db=n.result,e()},n.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains("notes")||t.createObjectStore("notes",{keyPath:"id"}),t.objectStoreNames.contains("contexts")||t.createObjectStore("contexts",{keyPath:"id"})}})}async saveNote(e){if(!this.db)return;const t=`${e.context}-${e.date}`;this.pendingWrites.set(t,{...e,id:t,_localTimestamp:Date.now(),_cachedAt:Date.now(),updated_at:e.updated_at||(new Date).toISOString()}),this.scheduleBatchWrite()}scheduleBatchWrite(){this.writeTimer&&clearTimeout(this.writeTimer),this.writeTimer=window.setTimeout(()=>{this.flushPendingWrites()},this.BATCH_DELAY)}async flushPendingWrites(){if(!this.db||0===this.pendingWrites.size)return;const e=Array.from(this.pendingWrites.values());this.pendingWrites.clear();const t=this.db.transaction(["notes"],"readwrite"),n=t.objectStore("notes");return e.forEach(e=>{n.put(e)}),new Promise((e,n)=>{t.oncomplete=()=>{e()},t.onerror=()=>n(t.error)})}async saveNoteImmediate(e){if(!this.db)return;const t=this.db.transaction(["notes"],"readwrite"),n=t.objectStore("notes"),s=`${e.context}-${e.date}`;return n.put({...e,id:s,_localTimestamp:Date.now(),_cachedAt:Date.now(),updated_at:e.updated_at||(new Date).toISOString()}),new Promise((e,n)=>{t.oncomplete=()=>e(),t.onerror=()=>n(t.error)})}async getNote(e,t){if(!this.db)return null;const n=this.db.transaction(["notes"],"readonly").objectStore("notes"),s=`${e}-${t}`;return new Promise(e=>{const t=n.get(s);t.onsuccess=()=>e(t.result||null),t.onerror=()=>e(null)})}async saveNotes(e){if(!this.db)return;const t=this.db.transaction(["notes"],"readwrite"),n=t.objectStore("notes"),s=Date.now();return e.forEach(e=>{const t=`${e.context}-${e.date}`;n.put({...e,id:t,_localTimestamp:s,_cachedAt:s,updated_at:e.updated_at||(new Date).toISOString()})}),new Promise((e,n)=>{t.oncomplete=()=>e(),t.onerror=()=>n(t.error)})}async getNotesByContext(e){if(!this.db)return[];const t=this.db.transaction(["notes"],"readonly").objectStore("notes");return new Promise(n=>{const s=t.getAll();s.onsuccess=()=>{const t=s.result||[];n(t.filter(t=>t.context===e))},s.onerror=()=>n([])})}async saveContexts(e){if(!this.db)return;if(!e||!Array.isArray(e))return;const t=this.db.transaction(["contexts"],"readwrite"),n=t.objectStore("contexts");return e.forEach(e=>{n.put({...e,_localTimestamp:Date.now()})}),new Promise((e,n)=>{t.oncomplete=()=>e(),t.onerror=()=>n(t.error)})}async getContexts(){if(!this.db)return[];const e=this.db.transaction(["contexts"],"readonly").objectStore("contexts");return new Promise(t=>{const n=e.getAll();n.onsuccess=()=>t(n.result||[]),n.onerror=()=>t([])})}async deleteNote(e,t){if(!this.db)return;const n=`${e}-${t}`;this.pendingWrites.delete(n);const s=this.db.transaction(["notes"],"readwrite");return s.objectStore("notes").delete(n),new Promise((e,t)=>{s.oncomplete=()=>{e()},s.onerror=()=>t(s.error)})}async clear(){if(!this.db)return;const e=this.db.transaction(["notes","contexts"],"readwrite");return e.objectStore("notes").clear(),e.objectStore("contexts").clear(),new Promise((t,n)=>{e.oncomplete=()=>t(),e.onerror=()=>n(e.error)})}};class n extends EventTarget{emit(e,t){this.dispatchEvent(new CustomEvent(e,{detail:t}))}on(e,t){const n=t;return this.addEventListener(e,n),()=>this.removeEventListener(e,n)}once(e,t){const n=t,s=t=>{n(t),this.removeEventListener(e,s)};return this.addEventListener(e,s),()=>this.removeEventListener(e,s)}}const s=new n,o="note-loaded",i="note-saved",a="context-changed",r="contexts-loaded",l="date-changed",c="show-error",d="show-success",u=new class{async request(t,n={}){try{const o=await fetch(t,{...n,headers:{...n.headers,"Content-Type":"application/json"},credentials:"same-origin"});if(!o.ok){const n=await o.json().catch(()=>({}));if(401===o.status||403===o.status){if(!e.get("isLoggingOut")){const e=t.includes("/api/notes"),n=e?"Session expired. Your notes are saved locally and will sync when you sign in again.":"Session expired. Please login again.";s.emit(c,{message:n}),s.emit("session-expired",{isNoteRequest:e})}throw e.set("currentUser",null),new Error("Session expired")}throw new Error(n.error||`Request failed with status ${o.status}`)}return await o.json()}catch(o){throw e.get("isLoggingOut")||o instanceof Error&&!o.message.includes("Session expired")&&s.emit(c,{message:o.message||"An error occurred"}),o}}async checkAuth(){try{const e=await fetch("/api/auth/me");return await e.json()}catch(e){return{authenticated:!1}}}async login(e,t){return await this.request("/api/auth/login",{method:"POST",body:JSON.stringify({access_token:e,expires_in:t||3600})})}async loginWithCode(e){return await this.request("/api/auth/login",{method:"POST",body:JSON.stringify({code:e})})}async logout(){await this.request("/api/auth/logout",{method:"POST"})}async getContexts(){return await this.request("/api/contexts")}async createContext(e){return await this.request("/api/contexts",{method:"POST",body:JSON.stringify(e)})}async updateContext(e,t){return await this.request(`/api/contexts/${e}`,{method:"PUT",body:JSON.stringify(t)})}async deleteContext(e){await this.request(`/api/contexts/${e}`,{method:"DELETE"})}async getNote(e,t){return await this.request(`/api/notes?context=${encodeURIComponent(e)}&date=${t}`)}async saveNote(e){return await this.request("/api/notes",{method:"POST",body:JSON.stringify(e)})}async getNotesList(e,t=50,n=0){return await this.request(`/api/notes/list?context=${encodeURIComponent(e)}&limit=${t}&offset=${n}`)}async deleteNote(e,t){const n=encodeURIComponent(e),s=encodeURIComponent(t);await this.request(`/api/notes/${n}/${s}`,{method:"DELETE"})}async updateSettings(e){return await this.request("/api/settings",{method:"PUT",body:JSON.stringify(e)})}async getServerTime(e){const t=await fetch(`/api/time?timezone=${encodeURIComponent(e)}`);return await t.json()}},m=new class{codeClient=null;initializationPromise=null;async checkAuth(){const t=await u.checkAuth();return!(!t.authenticated||!t.user||(e.update({currentUser:t.user,userSettings:t.user.settings||{theme:"dark",weekStart:0,timezone:"UTC",dateFormat:"DD-MM-YY",uniqueContextMode:!1,showBreadcrumb:!1,showMarkdownEditor:!1,hideNewContextButton:!1}}),0))}async initGoogleClient(e){return this.initializationPromise?this.initializationPromise:this.codeClient?Promise.resolve():(this.initializationPromise=new Promise((t,n)=>{const s=()=>{if(window.google?.accounts?.oauth2)try{this.codeClient=window.google.accounts.oauth2.initCodeClient({client_id:e,scope:"https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.email",ux_mode:"popup",callback:e=>this.handleAuthCodeResponse(e)}),t()}catch(o){n(o)}else setTimeout(s,100)};s(),setTimeout(()=>{this.codeClient||n(new Error("Google API failed to load within timeout"))},1e4)}),this.initializationPromise)}async handleAuthCodeResponse(t){const n=document.getElementById("landing-loader");if(t.error)return n&&n.classList.remove("visible"),void s.emit(c,{message:"OAuth failed: "+t.error});if(!t.code)return n&&n.classList.remove("visible"),void s.emit(c,{message:"OAuth failed: No code received"});try{const o=await u.loginWithCode(t.code);o.success&&o.user?(e.update({currentUser:o.user,userSettings:o.user.settings||{theme:"dark",weekStart:0,timezone:"UTC",dateFormat:"DD-MM-YY",uniqueContextMode:!1,showBreadcrumb:!1,showMarkdownEditor:!1,hideNewContextButton:!1}}),s.emit("auth-success",{})):(n&&n.classList.remove("visible"),s.emit(c,{message:o.error||"Login failed"}))}catch(o){n&&n.classList.remove("visible");const e=o instanceof Error?o.message:"Unknown error";s.emit(c,{message:"Login failed: "+e})}}async signIn(){const e=document.getElementById("landing-loader");e&&e.classList.add("visible");try{if(await this.initializationPromise,!this.codeClient)throw new Error("Google client not initialized");this.codeClient.requestCode()}catch(t){e&&e.classList.remove("visible"),s.emit(c,{message:"Failed to initialize Google sign-in. Please refresh the page."})}}signOut(){fetch("/api/auth/logout",{method:"POST",credentials:"same-origin"}).then(()=>{}).catch(e=>{});try{localStorage.clear(),sessionStorage.clear()}catch(e){}setTimeout(()=>{window.location.href="/",setTimeout(()=>window.location.reload(),100)},50)}async clearAllCaches(){try{const e="DailyNotesDB",t=indexedDB.deleteDatabase(e);if(await new Promise(e=>{t.onsuccess=()=>{e()},t.onerror=()=>{e()}}),"caches"in window){const e=await caches.keys();await Promise.all(e.map(e=>caches.delete(e)))}localStorage.clear(),sessionStorage.clear()}catch(e){}}};"undefined"!=typeof window&&(window.signInWithGoogle=()=>m.signIn());const h=new class{saveTimeout=null;currentNoteContent="";currentLoadToken=0;currentSelectToken=0;async loadNote(e,n){if(!e||!n)return null;const i=++this.currentLoadToken,a=await t.getNote(e,n);if(i!==this.currentLoadToken)return null;a&&a.content?(this.currentNoteContent=a.content,s.emit(o,{context:e,date:n,content:this.currentNoteContent})):(this.currentNoteContent="",s.emit(o,{context:e,date:n,content:""}));try{const{note:r}=await u.getNote(e,n);if(i!==this.currentLoadToken)return null;const l=r.updated_at?new Date(r.updated_at).getTime():0,c=a?.updated_at?new Date(a.updated_at).getTime():0;return(!a||l>c||r.content&&!a.content)&&(this.currentNoteContent=r.content||"",await t.saveNote({...r,context:e,date:n,content:r.content,updated_at:r.updated_at}),a&&a.content===r.content||s.emit(o,{context:e,date:n,content:this.currentNoteContent})),r}catch(r){return i!==this.currentLoadToken?null:(a||s.emit(c,{message:"Failed to load note. Working offline."}),a)}}async saveNote(e,n,o){if(!e||!n)return;const a=(new Date).toISOString(),r={context:e,date:n,content:o,updated_at:a};await t.saveNote(r),this.currentNoteContent=o,s.emit(i,{context:e,date:n,content:o}),this.updateNoteInList(e,n,o);try{await u.saveNote({context:e,date:n,content:o,updated_at:a})}catch(l){}}async loadNotesList(n,s=50,o=0){if(!n)return e.update({notes:[],notesWithDates:[]}),[];try{const i=(await u.getNotesList(n,s,o)).notes||[],a=await t.getNotesByContext(n),r=new Map;i.forEach(e=>{r.set(e.date,e)}),a.forEach(e=>{r.has(e.date)||r.set(e.date,e)});const l=Array.from(r.values()).sort((e,t)=>t.date.localeCompare(e.date)),c=l.map(e=>e.date);return e.update({notes:l,notesWithDates:c}),l}catch(i){return[]}}async refreshNotesList(e){await this.loadNotesList(e)}updateNoteInList(t,n,s){const o=e.get("notes").map(e=>e.date===n&&e.context===t?{...e,content:s,updated_at:(new Date).toISOString()}:e);e.set("notes",o)}ensureNoteInList(t,n){const s=e.get("notes"),o=e.get("notesWithDates");if(!s.some(e=>e.date===n)){const i={id:`temp-${t}-${n}`,user_id:e.get("currentUser")?.id||"",context:t,date:n,content:"",created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()},a=[...s,i].sort((e,t)=>t.date.localeCompare(e.date)),r=[...o,n];e.update({notes:a,notesWithDates:r})}}handleNoteInput(t){this.saveTimeout&&clearTimeout(this.saveTimeout),this.currentNoteContent=t;const n=e.get("selectedContext"),s=e.get("selectedDate");n&&s&&(this.saveTimeout=window.setTimeout(()=>{const t=e.get("selectedContext"),o=e.get("selectedDate");t===n&&o===s&&this.saveNote(n,s,this.currentNoteContent)},500))}async selectDate(t){const n=++this.currentSelectToken,o=e.get("selectedContext"),i=t.split("-"),a=parseInt(i[0]),r=parseInt(i[1])-1;if(e.update({selectedDate:t,currentCalendarMonth:r,currentCalendarYear:a}),n===this.currentSelectToken&&(s.emit(l,{date:t}),o)){if(n!==this.currentSelectToken)return;this.ensureNoteInList(o,t),await this.loadNote(o,t)}}setTodayDate(){const t=e.get("today"),[n,s]=t.split("-").map(Number);e.update({selectedDate:t,currentCalendarMonth:s-1,currentCalendarYear:n})}getCurrentNoteContent(){return this.currentNoteContent}async deleteNote(n,i){if(!n||!i)return;this.saveTimeout&&(clearTimeout(this.saveTimeout),this.saveTimeout=null),await t.deleteNote(n,i);const a=e.get("notes").filter(e=>!(e.date===i&&e.context===n)),r=e.get("notesWithDates").filter(e=>e!==i);if(e.update({notes:a,notesWithDates:r}),e.get("selectedDate")===i)if(this.currentNoteContent="",a.length>0){const e=a[0];await this.selectDate(e.date)}else this.setTodayDate(),s.emit(o,{context:n,date:i,content:""});try{await u.deleteNote(n,i)}catch(l){}}},g=new class{async loadContexts(){const n=await t.getContexts();n.length>0&&e.set("contexts",n);try{const n=await u.getContexts(),o=n?.contexts||[];await t.saveContexts(o),e.set("contexts",o),s.emit(r,{contexts:o})}catch(o){0!==n.length||navigator.onLine||s.emit(c,{message:"Failed to load contexts. Working offline."})}}async createContext(n,s){const o={id:`temp-${Date.now()}`,user_id:e.get("currentUser")?.id||"",name:n,color:s||"primary",created_at:(new Date).toISOString()},i=[...e.get("contexts"),o];await t.saveContexts(i),e.set("contexts",i),e.set("selectedContext",n);try{await u.createContext({name:n,color:s}),await this.loadContexts()}catch(a){}return o}async updateContext(n,o,i){try{await u.updateContext(n,{name:o,color:i});const a=e.get("contexts"),r=a.map(e=>e.id===n?{...e,name:o,color:i}:e);await t.saveContexts(r),e.set("contexts",r);const l=e.get("selectedContext"),c=a.find(e=>e.id===n);return l===c?.name&&(e.set("selectedContext",o),localStorage.setItem("lastContext",o)),s.emit(d,{message:"Context updated successfully"}),!0}catch(a){return s.emit(c,{message:"Failed to update context"}),!1}}async deleteContext(n){try{await u.deleteContext(n);const o=e.get("contexts").filter(e=>e.id!==n);await t.saveContexts(o),e.set("contexts",o),s.emit(d,{message:"Context deleted successfully"})}catch(o){s.emit(c,{message:"Failed to delete context"})}}selectContext(t){e.set("selectedContext",t),s.emit(a,{context:t}),t&&localStorage.setItem("lastContext",t)}getSelectedContext(){return e.get("selectedContext")}getContextColor(t){const n=e.get("contexts").find(e=>e.name===t),s=n?.color||"primary";return["text","link","primary","info","success","warning","danger"].includes(s)?s:"primary"}restoreLastContext(){const t=e.get("contexts"),n=e.get("userSettings").uniqueContextMode||!1;if(!t||0===t.length)return null;if(n){const e=t[0].name;return this.selectContext(e),e}const s=localStorage.getItem("lastContext");if(s&&t.some(e=>e.name===s))return this.selectContext(s),s;const o=t[0].name;return this.selectContext(o),o}},y=new class{monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"];dayNamesDefault=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];render(){const t=e.get("userSettings").weekStart||0,n=e.get("currentCalendarMonth"),s=e.get("currentCalendarYear"),o=e.get("selectedDate"),i=e.get("today"),a=e.get("notesWithDates"),r=[...this.dayNamesDefault.slice(t),...this.dayNamesDefault.slice(0,t)],l=document.getElementById("calendar-month-year");l&&(l.textContent=`${this.monthNames[n]} ${s}`);const c=(new Date(s,n,1).getDay()-t+7)%7,d=new Date(s,n+1,0).getDate(),u=new Date(s,n,0).getDate(),m=document.getElementById("calendar-grid");if(!m)return;let g=r.map(e=>`<div class="calendar-day-header">${e}</div>`).join("");for(let e=c-1;e>=0;e--)g+=`<div class="calendar-day other-month">${u-e}</div>`;for(let e=1;e<=d;e++){const t=`${s}-${String(n+1).padStart(2,"0")}-${String(e).padStart(2,"0")}`,r=["calendar-day"];t===i&&r.push("today"),t===o&&r.push("selected"),a.includes(t)&&r.push("has-note"),g+=`<div class="${r.join(" ")}" data-date="${t}">${e}</div>`}const y=c+d,p=y%7==0?0:7-y%7;for(let e=1;e<=p;e++)g+=`<div class="calendar-day other-month">${e}</div>`;m.innerHTML=g,m.querySelectorAll(".calendar-day:not(.other-month)").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.date;t&&h.selectDate(t)})})}prevMonth(){let t=e.get("currentCalendarMonth"),n=e.get("currentCalendarYear");t--,t<0&&(t=11,n--),e.update({currentCalendarMonth:t,currentCalendarYear:n}),this.render()}nextMonth(){let t=e.get("currentCalendarMonth"),n=e.get("currentCalendarYear");t++,t>11&&(t=0,n++),e.update({currentCalendarMonth:t,currentCalendarYear:n}),this.render()}goToToday(){const t=e.get("today");h.selectDate(t)}},p=new class{container=null;editor=null;editorElement=null;onChangeCallback=null;isUpdating=!1;currentNoteContent="";updateTimeout=null;contentVersion=0;async init(e,t){this.container=document.getElementById(e),this.container&&(this.onChangeCallback=t,this.container.innerHTML='<div style="padding: 1rem; color: var(--bulma-text-light); opacity: 0.6;">Editor loading...</div>')}async ensureQuillLoaded(){this.editor||(await this.loadQuill(),this.render(),this.initQuill())}async loadQuill(){if(window.Quill)return;const e=document.createElement("link");e.rel="stylesheet",e.href="/static/vendor/quill/quill.snow.css",document.head.appendChild(e);const t=document.createElement("script");t.src="/static/vendor/quill/quill.min.js",document.head.appendChild(t),await new Promise(e=>{t.onload=()=>e()})}render(){this.container&&(this.container.innerHTML='\n      <div class="quill-editor-wrapper">\n        <div id="quill-editor"></div>\n      </div>\n    ',this.editorElement=document.getElementById("quill-editor"))}initQuill(){if(window.Quill)try{this.editor=new window.Quill(this.editorElement,{theme:"snow",modules:{toolbar:[[{header:[1,2,3,!1]}],["bold","italic","strike"],[{list:"ordered"},{list:"bullet"}],["blockquote","code-block"],["link"],["clean"]]},placeholder:"Start writing your notes...",formats:["bold","italic","strike","header","list","code-block","blockquote","link"]}),this.editor.on("text-change",()=>{if(!this.isUpdating&&this.onChangeCallback){const e=this.getMarkdown();this.onChangeCallback(e)}}),this.editor.root.addEventListener("focus",()=>{""===this.editor.getText().trim()&&(this.editor.root.dataset.placeholder="")}),this.editor.root.addEventListener("blur",()=>{""===this.editor.getText().trim()&&(this.editor.root.dataset.placeholder="Start writing your notes...")}),this.applyToolbarVisibility()}catch(e){}}applyToolbarVisibility(){const t=!0===e.get("userSettings").showMarkdownEditor,n=this.container?.querySelector(".ql-toolbar");if(n&&(n.style.display=t?"":"none"),this.editor){const t=e.get("selectedContext");this.editor.enable(!!t)}}getMarkdown(){if(!this.editor)return"";const e=this.editor.getContents();let t="",n=null,s=0;return e.ops.forEach(e=>{if(!e.insert)return;const o="string"==typeof e.insert?e.insert:"",i=e.attributes||{};if("\n"===o)if(i.header)t=t.trimEnd(),t="#".repeat(i.header)+" "+t.split("\n").pop(),t+="\n\n";else if(i.list){i.list!==n&&(n=i.list,s=1);const e=t.split("\n").pop();t=t.substring(0,t.lastIndexOf("\n")+1),"ordered"===i.list?t+=`${s++}. ${e}\n`:"bullet"===i.list?t+=`- ${e}\n`:"check"===i.list&&(t+=`- [ ] ${e}\n`)}else if(n=null,s=0,i.blockquote){const e=t.split("\n").pop();t=t.substring(0,t.lastIndexOf("\n")+1),t+=`> ${e}\n`}else i["code-block"]?t+="\n```\n":t+="\n";else{let e=o;i.bold&&(e=`**${e}**`),i.italic&&(e=`*${e}*`),i.strike&&(e=`~~${e}~~`),i.code&&(e=`\`${e}\``),i.link&&(e=`[${e}](${i.link})`),t+=e}}),t.trim()}async setContent(t){if(await this.ensureQuillLoaded(),this.editor){this.contentVersion++,this.contentVersion,this.updateTimeout&&(clearTimeout(this.updateTimeout),this.updateTimeout=null),this.editor.disable(),this.isUpdating=!0;try{if(t){const e=this.markdownToDelta(t);this.editor.setContents(e),this.currentNoteContent=t}else this.editor.setText(""),this.currentNoteContent=""}finally{this.updateTimeout=window.setTimeout(()=>{this.isUpdating=!1,this.updateTimeout=null,e.get("selectedContext")&&this.editor&&this.editor.enable(!0)},600)}}}markdownToDelta(e){const t=[],n=e.split("\n");return n.forEach((e,s)=>{const o=e.match(/^(#{1,3})\s+(.+)$/);if(o){const e=o[1].length;return t.push({insert:o[2]}),void t.push({insert:"\n",attributes:{header:e}})}const i=e.match(/^-\s+(.+)$/);if(i){const e=this.parseInlineMarkdown(i[1]);return t.push(...e),void t.push({insert:"\n",attributes:{list:"bullet"}})}const a=e.match(/^\d+\.\s+(.+)$/);if(a){const e=this.parseInlineMarkdown(a[1]);return t.push(...e),void t.push({insert:"\n",attributes:{list:"ordered"}})}const r=e.match(/^-\s+\[([ x])\]\s+(.+)$/);if(r){const e=this.parseInlineMarkdown(r[2]);return t.push(...e),void t.push({insert:"\n",attributes:{list:"check"}})}const l=e.match(/^>\s+(.+)$/);if(l){const e=this.parseInlineMarkdown(l[1]);return t.push(...e),void t.push({insert:"\n",attributes:{blockquote:!0}})}if(e.startsWith("```"))t.push({insert:"\n",attributes:{"code-block":!0}});else{if(e.trim()){const n=this.parseInlineMarkdown(e);t.push(...n)}s<n.length-1&&t.push({insert:"\n"})}}),{ops:t}}parseInlineMarkdown(e){const t=[],n=/(\*\*([^*]+)\*\*)|(\*([^*]+)\*)|(~~([^~]+)~~)|(`([^`]+)`)|(\[([^\]]+)\]\(([^)]+)\))/g;let s,o=0;for(;null!==(s=n.exec(e));)s.index>o&&t.push({insert:e.substring(o,s.index)}),s[1]?t.push({insert:s[2],attributes:{bold:!0}}):s[3]?t.push({insert:s[4],attributes:{italic:!0}}):s[5]?t.push({insert:s[6],attributes:{strike:!0}}):s[7]?t.push({insert:s[8],attributes:{code:!0}}):s[9]&&t.push({insert:s[10],attributes:{link:s[11]}}),o=n.lastIndex;return o<e.length&&t.push({insert:e.substring(o)}),t.length>0?t:[{insert:e}]}getContent(){return this.getMarkdown()}async setDisabled(e){if(e||await this.ensureQuillLoaded(),!this.editor)return;this.editor.enable(!e);const t=this.container?.querySelector(".ql-toolbar");t&&(t.style.pointerEvents=e?"none":"auto",t.style.opacity=e?"0.5":"1");const n=this.editor.root;n&&e?n.dataset.placeholder="Select a context to start writing...":n&&(n.dataset.placeholder="Start writing your notes...")}setPlaceholderMessage(e){this.ensureQuillLoaded().then(()=>{if(!this.editor)return;const t=this.editor.root;t&&(t.dataset.placeholder=e)})}focus(){this.editor&&this.editor.focus()}forceFlush(){if(!this.editor||this.isUpdating)return;const e=this.getMarkdown();this.onChangeCallback&&this.onChangeCallback(e)}hasPendingChanges(){return!!this.editor&&this.getMarkdown()!==this.currentNoteContent}},w=new class{container;notifications=new Map;queue=[];maxVisible=3;defaultDuration=5e3;constructor(){this.container=this.init()}init(){const e=document.createElement("div");return e.id="notification-container",e.className="notification-container",e.setAttribute("role","region"),e.setAttribute("aria-label","Notifications"),document.body.appendChild(e),e}show(e){const{type:t="info",title:n,message:s,duration:o=this.defaultDuration,dismissible:i=!0,onAction:a,actionLabel:r="Action"}=e,l=`notification-${Date.now()}-${Math.random()}`,c={id:l,type:t,title:n,message:s,duration:o,dismissible:i,onAction:a,actionLabel:r,element:null};return this.container.children.length>=this.maxVisible?(this.queue.push(c),l):(this.render(c),l)}render(e){const{id:t,type:n,title:s,message:o,duration:i,dismissible:a,onAction:r,actionLabel:l}=e,c=document.createElement("div");if(c.className=`notification-toast notification-${n}`,c.setAttribute("role","alert"),c.setAttribute("aria-live","error"===n?"assertive":"polite"),c.dataset.id=t,c.innerHTML=`\n      <div class="notification-icon">\n        <span class="material-symbols-outlined">${{success:"check_circle",error:"error",warning:"warning",info:"info"}[n]}</span>\n      </div>\n      <div class="notification-content">\n        ${s?`<div class="notification-title">${this.escapeHtml(s)}</div>`:""}\n        <div class="notification-message">${this.escapeHtml(o)}</div>\n      </div>\n      ${r?`\n        <button class="notification-action" aria-label="${l}">\n          ${l}\n        </button>\n      `:""}\n      ${a?'\n        <button class="notification-close" aria-label="Close notification">\n          <span class="material-symbols-outlined">close</span>\n        </button>\n      ':""}\n    `,a){const e=c.querySelector(".notification-close");e?.addEventListener("click",()=>this.dismiss(t))}if(r){const e=c.querySelector(".notification-action");e?.addEventListener("click",()=>{r(),this.dismiss(t)})}this.container.appendChild(c),e.element=c,this.notifications.set(t,e),requestAnimationFrame(()=>{c.classList.add("notification-visible")}),i&&i>0&&(e.timeout=window.setTimeout(()=>{this.dismiss(t)},i))}dismiss(e){const t=this.notifications.get(e);if(!t)return;const{element:n,timeout:s}=t;s&&clearTimeout(s),n?.classList.remove("notification-visible"),n?.classList.add("notification-hiding"),setTimeout(()=>{n?.parentNode&&n.parentNode.removeChild(n),this.notifications.delete(e),this.processQueue()},300)}processQueue(){const e=this.container.children.length;if(this.queue.length>0&&e<this.maxVisible){const e=this.queue.shift();e&&this.render(e)}}success(e,t={}){return this.show({type:"success",message:e,title:"Success",...t})}error(e,t={}){return this.show({type:"error",message:e,title:"Error",duration:7e3,...t})}warning(e,t={}){return this.show({type:"warning",message:e,title:"Warning",...t})}info(e,t={}){return this.show({type:"info",message:e,...t})}clearAll(){this.notifications.forEach(e=>{this.dismiss(e.id)}),this.queue=[]}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}},b=new class{elements;lastKnownDate;INITIAL_RENDER_COUNT;renderedNotesCount;constructor(){this.elements={},this.lastKnownDate=null,this.INITIAL_RENDER_COUNT=50,this.renderedNotesCount=this.INITIAL_RENDER_COUNT}init(){this.cacheElements(),this.setupEventListeners(),this.setupStateSubscriptions(),this.setupUserDropdown(),this.setupMobileNavigation(),this.startClock()}cacheElements(){this.elements={authSection:document.getElementById("auth-section"),appSection:document.getElementById("app-section"),contextSelect:document.getElementById("context-select"),contextColorIndicator:document.getElementById("context-color-indicator"),mobileContextSelect:document.getElementById("mobile-context-select"),mobileContextColorIndicator:document.getElementById("mobile-context-color-indicator"),datePicker:document.getElementById("date-picker"),breadcrumbContextName:document.getElementById("breadcrumb-context-name"),breadcrumbDateName:document.getElementById("breadcrumb-date-name"),markdownEditorContainer:document.getElementById("markdown-editor-container"),saveIndicator:document.getElementById("save-indicator"),notesList:document.getElementById("notes-list"),userEmail:document.getElementById("user-email"),currentTime:document.getElementById("current-time"),currentDate:document.getElementById("current-date"),contextModal:document.getElementById("context-modal"),settingsModal:document.getElementById("settings-modal"),onboardingModal:document.getElementById("onboarding-modal"),syncStatus:document.getElementById("sync-status"),syncStatusText:document.getElementById("sync-status-text"),themeToggleMenu:document.getElementById("theme-toggle-menu"),themeToggleSwitch:document.getElementById("theme-toggle-switch"),weekStartSelect:document.getElementById("week-start-select"),timezoneSelect:document.getElementById("timezone-select"),mobileNotesToggle:document.getElementById("mobile-notes-toggle"),mobileCalendarToggle:document.getElementById("mobile-calendar-toggle"),sidebar:document.querySelector(".sidebar"),calendarPanel:document.querySelector(".calendar-panel"),sidebarOverlay:document.getElementById("sidebar-overlay"),calendarOverlay:document.getElementById("calendar-overlay"),sidebarClose:document.getElementById("sidebar-close"),calendarClose:document.getElementById("calendar-close")}}setupEventListeners(){const t=document.getElementById("editor-fullscreen-btn");t&&t.addEventListener("click",()=>{this.openFullscreenNote()});const n=document.getElementById("editor-delete-note-btn");n&&n.addEventListener("click",()=>{const t=e.get("selectedContext"),n=e.get("selectedDate");if(t&&n){const s=e.get("userSettings"),o=s.timezone||"UTC",i=s.dateFormat||"DD-MM-YY",[a,r,l]=n.split("-").map(Number),c=new Date(a,r-1,l).toLocaleDateString("en-US",{weekday:"long",timeZone:o}),d=String(a).substring(2),u=String(r).padStart(2,"0"),m=String(l).padStart(2,"0");let h;h="MM-DD-YY"===i?`${u}-${m}-${d}`:`${m}-${u}-${d}`;const g=`${c}, ${h}`;this.showDeleteNoteModal(t,n,g)}}),this.elements.contextSelect?.addEventListener("change",e=>{const t=e.target.value;g.selectContext(t)}),this.elements.mobileContextSelect?.addEventListener("change",e=>{const t=e.target.value;g.selectContext(t)}),this.elements.datePicker?.addEventListener("change",async t=>{const n=t.target.value;e.get("selectedDate")!==n&&await h.selectDate(n)}),document.getElementById("prev-month")?.addEventListener("click",()=>{y.prevMonth()}),document.getElementById("next-month")?.addEventListener("click",()=>{y.nextMonth()}),this.elements.themeToggleMenu?.addEventListener("click",async t=>{t.preventDefault();const n="dark"===document.documentElement.getAttribute("data-theme")?"light":"dark";this.setTheme(n);const s=e.get("userSettings");e.set("userSettings",{...s,theme:n});try{await u.updateSettings({...s,theme:n})}catch(o){}}),this.elements.themeToggleSwitch?.addEventListener("change",e=>{this.setTheme(e.target.checked?"dark":"light")}),this.setupKeyboardShortcuts()}setupKeyboardShortcuts(){document.addEventListener("keydown",e=>{const t=navigator.platform.toUpperCase().indexOf("MAC")>=0?e.metaKey:e.ctrlKey;if(t&&"k"===e.key)return e.preventDefault(),void this.elements.contextSelect?.focus();if(t&&"s"===e.key)return e.preventDefault(),void s.emit("sync-force",void 0);if(t&&"/"===e.key)e.preventDefault();else if("Escape"===e.key){const e=document.getElementById("delete-note-modal");return e?.classList.contains("is-active")?void this.closeDeleteNoteModal():void this.closeAllModals()}})}setupUserDropdown(){const e=document.getElementById("user-dropdown"),t=document.getElementById("user-dropdown-button"),n=document.getElementById("settings-menu-item"),s=document.getElementById("signout-menu-item");e&&t&&(t.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),e.classList.toggle("is-active")}),n?.addEventListener("click",t=>{t.preventDefault(),e.classList.remove("is-active"),this.showSettingsModal()}),s?.addEventListener("click",t=>{t.preventDefault(),e.classList.remove("is-active"),m.signOut()}),document.addEventListener("click",t=>{e.contains(t.target)||e.classList.remove("is-active")}),document.addEventListener("keydown",t=>{"Escape"===t.key&&e.classList.contains("is-active")&&e.classList.remove("is-active")}))}setupStateSubscriptions(){e.subscribe("contexts",()=>{this.renderContextsSelect()}),e.subscribeMany(["currentCalendarMonth","currentCalendarYear"],()=>{y.render()}),e.subscribe("notes",()=>{this.renderNotesList(),y.render()}),e.subscribe("selectedContext",e=>{this.updateBreadcrumb(),this.renderedNotesCount=this.INITIAL_RENDER_COUNT}),e.subscribe("selectedDate",e=>{this.elements.datePicker&&e&&(this.elements.datePicker.value=e,this.updateDatePickerDisplay(e)),this.renderNotesList(),y.render(),this.updateBreadcrumb(),this.updateEditorDeleteButton()}),e.subscribe("userSettings",()=>{const t=e.get("selectedDate");t&&this.updateDatePickerDisplay(t),this.updateBreadcrumb()}),e.subscribe("selectedContext",e=>{this.elements.contextSelect&&e&&(this.elements.contextSelect.value=e),this.elements.mobileContextSelect&&e&&(this.elements.mobileContextSelect.value=e),this.updateContextIndicator(),this.updateEditorState()}),e.subscribe("currentUser",e=>{this.elements.userEmail&&e&&(this.elements.userEmail.textContent=e.email||"")}),e.subscribe("userSettings",e=>{e.theme&&this.setTheme(e.theme),this.updateContextSelectorVisibility(),this.updateBreadcrumbVisibility(),this.updateMarkdownEditorVisibility(),this.updateNewContextButtonVisibility()})}renderContextsSelect(){const t=e.get("contexts"),n=e.get("selectedContext"),s='<option value="">Select context...</option>'+t.map(e=>`<option value="${e.name}" data-color="${e.color||"primary"}">${e.name}</option>`).join("");this.elements.contextSelect&&(this.elements.contextSelect.innerHTML=s,n&&(this.elements.contextSelect.value=n)),this.elements.mobileContextSelect&&(this.elements.mobileContextSelect.innerHTML=s,n&&(this.elements.mobileContextSelect.value=n)),this.updateContextIndicator()}updateContextIndicator(){if(this.elements.contextSelect&&this.elements.contextColorIndicator){const e=this.elements.contextSelect.options[this.elements.contextSelect.selectedIndex];if(e?.dataset.color&&""!==e.value){const t=this.normalizeToBulmaColor(e.dataset.color);this.elements.contextColorIndicator.style.background=`var(--bulma-${t})`,this.elements.contextColorIndicator.style.opacity="1"}else this.elements.contextColorIndicator.style.background="var(--bulma-grey-light)",this.elements.contextColorIndicator.style.opacity="0.3"}if(this.elements.mobileContextSelect&&this.elements.mobileContextColorIndicator){const e=this.elements.mobileContextSelect.options[this.elements.mobileContextSelect.selectedIndex];if(e?.dataset.color&&""!==e.value){const t=this.normalizeToBulmaColor(e.dataset.color);this.elements.mobileContextColorIndicator.style.background=`var(--bulma-${t})`,this.elements.mobileContextColorIndicator.style.opacity="1"}else this.elements.mobileContextColorIndicator.style.background="var(--bulma-grey-light)",this.elements.mobileContextColorIndicator.style.opacity="0.3"}}renderNotesList(){const t=e.get("notes"),n=e.get("selectedDate"),s=e.get("userSettings"),o=s.timezone||"UTC",i=s.dateFormat||"DD-MM-YY";if(!this.elements.notesList)return;if(0===t.length)return void(this.elements.notesList.innerHTML='<li class="has-text-centered py-6 has-text-grey-light">No notes yet</li>');const a=t.slice(0,this.renderedNotesCount),r=t.length>this.renderedNotesCount;this.elements.notesList.innerHTML=a.map(e=>{const[t,s,a]=e.date.split("-").map(Number),r=new Date(t,s-1,a).toLocaleDateString("en-US",{weekday:"long",timeZone:o}),l=String(t).substring(2),c=String(s).padStart(2,"0"),d=String(a).padStart(2,"0");let u;u="MM-DD-YY"===i?`${c}-${d}-${l}`:`${d}-${c}-${l}`;const m=`${r}, ${u}.md`;return`\n                <li>\n                    <a\n                        class="${e.date===n?"is-active":""}"\n                        data-date="${e.date}"\n                    >\n                        ${m}\n                    </a>\n                </li>\n            `}).join(""),r&&(this.elements.notesList.innerHTML+=`\n                <li class="has-text-centered py-3">\n                    <button class="button is-small is-ghost" id="load-more-notes" style="opacity: 0.7;">\n                        <span class="icon">\n                            <span class="material-symbols-outlined">expand_more</span>\n                        </span>\n                        <span>Load ${Math.min(50,t.length-this.renderedNotesCount)} more</span>\n                    </button>\n                </li>\n            `),this.elements.notesList.querySelectorAll("a[data-date]").forEach(t=>{t.addEventListener("click",async n=>{n.preventDefault();const s=t.dataset.date;if(s){if(e.get("selectedDate")===s)return;await h.selectDate(s)}})});const l=document.getElementById("load-more-notes");l&&l.addEventListener("click",()=>{this.renderedNotesCount+=50,this.renderNotesList()})}updateEditorState(){const t=e.get("selectedContext"),n=e.get("contexts")||[];t?p.setDisabled(!1):p.ensureQuillLoaded().then(()=>{p.setDisabled(!0),p.setContent(""),0===n.length&&setTimeout(()=>{p.setPlaceholderMessage('Click "New Context" to create your first context and start writing notes')},100)}),this.updateEditorDeleteButton()}updateEditorDeleteButton(){const t=document.getElementById("editor-delete-note-btn"),n=document.getElementById("editor-fullscreen-btn"),s=e.get("selectedContext"),o=e.get("selectedDate");s&&o?(t&&(t.style.display="flex"),n&&(n.style.display="flex")):(t&&(t.style.display="none"),n&&(n.style.display="none"))}updateSaveIndicator(e){this.elements.saveIndicator&&(this.elements.saveIndicator.className=`save-indicator ${e}`,"saved"===e?(this.elements.saveIndicator.textContent="Saved locally ✓",setTimeout(()=>{this.elements.saveIndicator&&(this.elements.saveIndicator.textContent="")},2e3)):this.elements.saveIndicator.textContent="")}updateSyncStatus({pending:e,syncing:t}){this.elements.syncStatus&&this.elements.syncStatusText&&(e>0||t?(this.elements.syncStatus.style.display="flex",t?(this.elements.syncStatusText.textContent=`Syncing ${e} note${1!==e?"s":""}...`,this.elements.syncStatus.classList.add("is-syncing"),this.elements.syncStatus.classList.remove("is-pending")):(this.elements.syncStatusText.textContent=`${e} note${1!==e?"s":""} pending sync`,this.elements.syncStatus.classList.add("is-pending"),this.elements.syncStatus.classList.remove("is-syncing"))):setTimeout(()=>{this.elements.syncStatus&&(this.elements.syncStatus.style.display="none",this.elements.syncStatus.classList.remove("is-syncing","is-pending"))},1e3))}setTheme(e){document.documentElement.setAttribute("data-theme",e),this.elements.themeToggleSwitch&&(this.elements.themeToggleSwitch.checked="dark"===e),this.updateThemeIcon(),localStorage.setItem("theme",e)}updateThemeIcon(){const e=document.documentElement.getAttribute("data-theme"),t=this.elements.themeToggleMenu?.querySelector(".material-symbols-outlined");t&&(t.textContent="dark"===e?"light_mode":"dark_mode")}showApp(t=!1){if(!this.elements.authSection||!this.elements.appSection)return;const n=document.getElementById("landing-loader");n&&n.classList.remove("visible"),this.elements.authSection.classList.remove("visible"),this.elements.appSection.classList.add("visible"),this.updateContextSelectorVisibility(),this.updateBreadcrumbVisibility(),this.updateMarkdownEditorVisibility(),this.updateNewContextButtonVisibility();const s=e.get("hasNoContexts");("development"===window.__ENV__||s)&&setTimeout(()=>{this.elements.onboardingModal?.classList.add("is-active")},500)}hideApp(){this.elements.authSection&&this.elements.appSection&&(this.elements.appSection.classList.remove("visible"),this.elements.authSection.classList.add("visible"))}showError(e,t={}){let n="Error",s=7e3,o="";"object"==typeof e?(n=e.title||"Error",o=e.message||"An error occurred",s=e.duration||7e3):o=e,(o.includes("network")||o.includes("offline"))&&(n="Connection Error",s=1e4),w.error(o,{title:n,duration:s,...t})}showSuccess(e,t={}){w.success(e,{duration:3e3,...t})}showWarning(e,t={}){w.warning(e,{duration:5e3,...t})}showInfo(e,t={}){w.info(e,{duration:4e3,...t})}showContextModal(){this.elements.contextModal?.classList.add("is-active");const e=document.getElementById("context-name"),t=document.getElementById("context-color");e&&(e.value=""),t&&(t.value="primary"),this.setupColorButtons(),this.selectColorButton("primary"),e?.focus()}closeContextModal(){this.elements.contextModal?.classList.remove("is-active")}showSettingsModal(){const t=e.get("userSettings");this.elements.weekStartSelect&&(this.elements.weekStartSelect.value=String(t.weekStart)),this.elements.timezoneSelect&&(this.elements.timezoneSelect.value=t.timezone);const n=document.getElementById("date-format-select");n&&(n.value=t.dateFormat||"DD-MM-YY");const s=document.getElementById("unique-context-mode-switch");s&&(s.checked=t.uniqueContextMode||!1);const o=document.getElementById("show-breadcrumb-switch");o&&(o.checked=!0===t.showBreadcrumb);const i=document.getElementById("show-markdown-editor-switch");i&&(i.checked=!0===t.showMarkdownEditor);const a=document.getElementById("hide-new-context-button-switch");a&&(a.checked=!0===t.hideNewContextButton);const r=document.getElementById("contexts-accordion-content"),l=document.getElementById("contexts-accordion-icon");if(r&&(r.style.display="none",r.style.opacity="1"),l){const e=l.querySelector(".material-symbols-outlined");e&&(e.textContent="expand_more")}this.renderContextsEditList();const c=document.getElementById("settings-save-btn"),d=document.getElementById("settings-save-icon"),u=document.getElementById("settings-save-spinner"),m=document.getElementById("settings-save-text");if(c&&(c.disabled=!1),d){d.style.display="inline-flex";const e=d.querySelector(".material-symbols-outlined");e&&(e.textContent="check")}u&&(u.style.display="none"),m&&(m.textContent="Save"),this.elements.settingsModal?.classList.add("is-active")}closeSettingsModal(){const e=document.getElementById("contexts-accordion-content"),t=document.getElementById("contexts-accordion-icon");if(e&&(e.style.display="none",e.style.opacity="1"),t){const e=t.querySelector(".material-symbols-outlined");e&&(e.textContent="expand_more")}this.elements.settingsModal?.classList.remove("is-active")}closeOnboardingModal(){this.elements.onboardingModal?.classList.remove("is-active")}showDeleteNoteModal(e,t,n){const s=document.getElementById("delete-note-modal"),o=document.getElementById("delete-note-message");s&&o&&(s.dataset.context=e,s.dataset.date=t,o.textContent=`Are you sure you want to delete the note for ${n}?`,s.classList.add("is-active"))}closeDeleteNoteModal(){const e=document.getElementById("delete-note-modal");e&&(e.classList.remove("is-active"),delete e.dataset.context,delete e.dataset.date)}closeAllModals(){this.closeContextModal(),this.closeSettingsModal(),this.closeOnboardingModal(),this.closeDeleteNoteModal()}startClock(){this.updateCurrentDateTime(),setInterval(()=>this.updateCurrentDateTime(),1e3)}updateCurrentDateTime(){const t=e.get("userSettings").timezone||"UTC",n=e.get("serverTimeOffset"),s=new Date(Date.now()+n),o={hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1,timeZone:t},i={weekday:"long",year:"numeric",month:"long",day:"numeric",timeZone:t},a=s.toLocaleTimeString("en-US",o),r=s.toLocaleDateString("en-US",i);this.elements.currentTime&&(this.elements.currentTime.textContent=a),this.elements.currentDate&&(this.elements.currentDate.textContent=r);const l=e.get("today");this.lastKnownDate&&this.lastKnownDate!==l&&y.render(),this.lastKnownDate=l}updateDatePickerDisplay(t){const n=document.getElementById("date-picker-display");if(!n||!t)return;const s=e.get("userSettings").dateFormat||"DD-MM-YY",[o,i,a]=t.split("-").map(Number),r=String(o).substring(2),l=String(i).padStart(2,"0"),c=String(a).padStart(2,"0");let d;d="MM-DD-YY"===s?`${l}/${c}/${r}`:`${c}/${l}/${r}`,n.textContent=d}updateContextSelectorVisibility(){const t=e.get("userSettings").uniqueContextMode||!1,n=document.getElementById("desktop-context-selector"),s=document.getElementById("mobile-context-selector");t?(n&&(n.style.display="none"),s&&(s.style.display="none")):(n&&(n.style.display=""),s&&(s.style.display=""))}updateBreadcrumbVisibility(){const t=!0===e.get("userSettings").showBreadcrumb,n=document.getElementById("drive-breadcrumb"),s=document.querySelector(".main-section");n&&(n.style.display=t?"":"none"),s&&(t?s.removeAttribute("data-hide-breadcrumb"):s.setAttribute("data-hide-breadcrumb","true"))}updateMarkdownEditorVisibility(){const t=!0===e.get("userSettings").showMarkdownEditor,n=document.querySelector(".ql-toolbar");n&&(n.style.display=t?"":"none");const s=e.get("selectedContext");p.setDisabled(!s)}updateNewContextButtonVisibility(){const t=!0===e.get("userSettings").hideNewContextButton,n=document.getElementById("desktop-new-context-btn"),s=document.getElementById("mobile-new-context-btn");n&&(n.style.display=t?"none":""),s&&(s.style.display=t?"none":"")}renderContextsEditList(){const t=e.get("contexts"),n=document.getElementById("contexts-edit-list");n&&(0!==t.length?n.innerHTML=t.map((e,t)=>{const n=this.normalizeToBulmaColor(e.color);return`\n            <div class="is-flex is-align-items-center is-justify-content-space-between mb-3"\n                 style="padding: 0.75rem 1rem; background: var(--bulma-scheme-main-bis); border-left: 3px solid var(--bulma-${n}); border-radius: 6px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">\n                <div class="is-flex is-align-items-center" style="gap: 0.75rem; flex: 1; min-width: 0;">\n                    <span style="display: block; width: 12px; height: 12px; background: var(--bulma-${n}); border-radius: 50%; flex-shrink: 0;"></span>\n                    <span style="font-size: 0.9rem; font-weight: 500; color: var(--bulma-text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${e.name}</span>\n                </div>\n                <div class="is-flex is-align-items-center" style="gap: 0.35rem;">\n                    <button class="button is-small context-action-btn context-edit-btn"\n                            onclick="window.showEditContextModal('${e.id}')"\n                            title="Edit context"\n                            style="padding: 0.35rem; border: none; background: transparent; border-radius: 50%; width: 32px; height: 32px;">\n                        <span class="icon is-small">\n                            <span class="material-symbols-outlined" style="font-size: 18px; color: var(--bulma-grey);">edit</span>\n                        </span>\n                    </button>\n                    <button class="button is-small context-action-btn context-delete-btn"\n                            onclick="window.showDeleteContextModal('${e.id}', '${e.name.replace(/'/g,"\\'")}')"\n                            title="Delete context"\n                            style="padding: 0.35rem; border: none; background: transparent; border-radius: 50%; width: 32px; height: 32px;">\n                        <span class="icon is-small">\n                            <span class="material-symbols-outlined" style="font-size: 18px; color: var(--bulma-grey);">delete</span>\n                        </span>\n                    </button>\n                </div>\n            </div>\n        `}).join(""):n.innerHTML='<p class="has-text-centered has-text-grey-light py-5">No contexts yet. Create your first context to get started!</p>')}getColorLabel(e){return{text:"Text (Gray)",link:"Link (Blue)",primary:"Primary (Cyan)",info:"Info (Light Blue)",success:"Success (Green)",warning:"Warning (Yellow)",danger:"Danger (Red)"}[e]||e}setupColorButtons(){const e=document.getElementById("context-color"),t=document.querySelectorAll("#context-color-buttons .color-btn");t.length&&(t.forEach(e=>{const t=e.cloneNode(!0);e.parentNode.replaceChild(t,e)}),document.querySelectorAll("#context-color-buttons .color-btn").forEach(t=>{t.addEventListener("click",n=>{n.preventDefault();const s=t.dataset.color;e&&s&&(e.value=s),document.querySelectorAll("#context-color-buttons .color-btn").forEach(e=>{e.classList.remove("is-active"),e.style.border="3px solid transparent",e.style.borderRadius="8px"}),t.classList.add("is-active"),t.style.border="3px solid var(--bulma-text)",t.style.borderRadius="8px"})}))}selectColorButton(e){const t=document.querySelectorAll("#context-color-buttons .color-btn"),n=document.getElementById("context-color");n&&(n.value=e),t.forEach(t=>{t.classList.remove("is-active"),t.style.border="3px solid transparent",t.style.borderRadius="8px",t.dataset.color===e&&(t.classList.add("is-active"),t.style.border="3px solid var(--bulma-text)",t.style.borderRadius="8px")})}normalizeToBulmaColor(e){return["text","link","primary","info","success","warning","danger"].includes(e)?e:{"#485fc7":"primary","#3e8ed0":"info","#48c78e":"success","#ffe08a":"warning","#f14668":"danger"}[e]||"primary"}setupMobileNavigation(){this.elements.mobileNotesToggle?.addEventListener("click",()=>{this.toggleMobileSidebar()}),this.elements.mobileCalendarToggle?.addEventListener("click",()=>{this.toggleMobileCalendar()}),this.elements.sidebarClose?.addEventListener("click",()=>{this.closeMobileSidebar()}),this.elements.calendarClose?.addEventListener("click",()=>{this.closeMobileCalendar()}),this.elements.sidebarOverlay?.addEventListener("click",()=>{this.closeMobileSidebar()}),this.elements.calendarOverlay?.addEventListener("click",()=>{this.closeMobileCalendar()}),this.elements.notesList&&this.elements.notesList.addEventListener("click",e=>{"A"===e.target.tagName&&window.innerWidth<=768&&this.closeMobileSidebar()}),window.addEventListener("resize",()=>{window.innerWidth>768&&(this.elements.sidebar&&(this.elements.sidebar.classList.remove("mobile-panel","active"),this.elements.sidebar.style.display=""),this.elements.calendarPanel&&(this.elements.calendarPanel.classList.remove("mobile-panel","active"),this.elements.calendarPanel.style.display=""),this.elements.sidebarOverlay&&this.elements.sidebarOverlay.classList.remove("active"),this.elements.calendarOverlay&&this.elements.calendarOverlay.classList.remove("active"),document.body.style.overflow="")})}toggleMobileSidebar(){this.elements.sidebar&&this.elements.sidebarOverlay&&(window.innerWidth>768||(this.elements.sidebar.classList.contains("mobile-panel")||(this.elements.sidebar.classList.add("mobile-panel"),this.elements.sidebar.style.display="flex"),this.elements.sidebar.classList.toggle("active"),this.elements.sidebarOverlay.classList.toggle("active"),this.elements.sidebar.classList.contains("active")?document.body.style.overflow="hidden":document.body.style.overflow=""))}closeMobileSidebar(){this.elements.sidebar&&this.elements.sidebarOverlay&&(this.elements.sidebar.classList.remove("active"),this.elements.sidebarOverlay.classList.remove("active"),document.body.style.overflow="")}toggleMobileCalendar(){this.elements.calendarPanel&&this.elements.calendarOverlay&&(window.innerWidth>768||(this.elements.calendarPanel.classList.contains("mobile-panel")||(this.elements.calendarPanel.classList.add("mobile-panel"),this.elements.calendarPanel.style.display="flex"),this.elements.calendarPanel.classList.toggle("active"),this.elements.calendarOverlay.classList.toggle("active"),this.elements.calendarPanel.classList.contains("active")?document.body.style.overflow="hidden":document.body.style.overflow=""))}closeMobileCalendar(){this.elements.calendarPanel&&this.elements.calendarOverlay&&(this.elements.calendarPanel.classList.remove("active"),this.elements.calendarOverlay.classList.remove("active"),document.body.style.overflow="")}updateBreadcrumb(){const t=e.get("selectedContext"),n=e.get("selectedDate"),s=e.get("userSettings"),o=s.timezone||"UTC",i=s.dateFormat||"DD-MM-YY";if(this.elements.breadcrumbContextName&&t&&(this.elements.breadcrumbContextName.textContent=t),this.elements.breadcrumbDateName&&n){const[e,t,s]=n.split("-").map(Number),a=new Date(e,t-1,s).toLocaleDateString("en-US",{weekday:"long",timeZone:o}),r=String(e).substring(2),l=String(t).padStart(2,"0"),c=String(s).padStart(2,"0");let d;d="MM-DD-YY"===i?`${l}-${c}-${r}`:`${c}-${l}-${r}`;const u=`${a}, ${d}.md`;this.elements.breadcrumbDateName.textContent=u}}openFullscreenNote(){const t=e.get("selectedContext"),n=e.get("selectedDate");if(!t||!n)return;const s=e.get("userSettings"),o=s.timezone||"UTC",i=s.dateFormat||"DD-MM-YY",[a,r,l]=n.split("-").map(Number),c=new Date(a,r-1,l).toLocaleDateString("en-US",{weekday:"long",timeZone:o}),d=String(a).substring(2),u=String(r).padStart(2,"0"),m=String(l).padStart(2,"0");let h;h="MM-DD-YY"===i?`${u}-${m}-${d}`:`${m}-${u}-${d}`;const g=`${c}, ${h}.md`,y=document.getElementById("fullscreen-note-modal"),w=document.getElementById("fullscreen-note-date"),b=document.getElementById("fullscreen-note-editor");if(!y||!w||!b)return;w.textContent=g;const x=p.getContent();if(window.Quill){b.innerHTML="";const e=new window.Quill(b,{theme:"snow",readOnly:!0,modules:{toolbar:!1}});e.root.innerHTML=x,e.root.style.fontSize="16px",e.root.style.lineHeight="1.6"}else b.innerHTML=x;y.classList.add("is-active");const v=e=>{"Escape"===e.key&&(this.closeFullscreenNote(),document.removeEventListener("keydown",v))};document.addEventListener("keydown",v)}closeFullscreenNote(){const e=document.getElementById("fullscreen-note-modal");e&&e.classList.remove("is-active")}};"undefined"!=typeof window&&(window.ui=b,window.showNewContextModal=()=>b.showContextModal(),window.closeContextModal=()=>b.closeContextModal(),window.createContext=async()=>{const t=document.getElementById("context-name"),n=document.getElementById("context-color"),s=t?.value.trim(),o=n?.value;if(!s)return;await g.createContext(s,o),b.closeContextModal(),await h.loadNotesList(s);const i=e.get("selectedDate");i&&await h.loadNote(s,i)},window.showSettingsModal=()=>b.showSettingsModal(),window.closeSettingsModal=()=>b.closeSettingsModal(),window.saveSettings=async()=>{const t=document.getElementById("settings-save-btn"),n=document.getElementById("settings-save-icon"),s=document.getElementById("settings-save-spinner"),o=document.getElementById("settings-save-text"),i=document.getElementById("settings-cancel-btn"),a=document.getElementById("week-start-select"),r=document.getElementById("timezone-select"),l=document.getElementById("date-format-select"),c=document.getElementById("unique-context-mode-switch"),d=document.getElementById("show-breadcrumb-switch"),m=document.getElementById("show-markdown-editor-switch"),p=document.getElementById("hide-new-context-button-switch"),x=e.get("userSettings"),v=parseInt(a?.value||"0"),C=r?.value||"UTC",f=l?.value||"DD-MM-YY",S=c?.checked||!1,E=!0===d?.checked,I=!0===m?.checked,L=!0===p?.checked,k=x.theme||"dark";t&&(t.disabled=!0),i&&(i.disabled=!0),n&&(n.style.display="none"),s&&(s.style.display="inline-block"),o&&(o.textContent="Saving...");try{if(await u.updateSettings({theme:k,weekStart:v,timezone:C,dateFormat:f,uniqueContextMode:S,showBreadcrumb:E,showMarkdownEditor:I,hideNewContextButton:L}),e.set("userSettings",{theme:k,weekStart:v,timezone:C,dateFormat:f,uniqueContextMode:S,showBreadcrumb:E,showMarkdownEditor:I,hideNewContextButton:L}),y.render(),o&&(o.textContent="Saved!"),s&&(s.style.display="none"),n){n.style.display="inline-flex";const e=n.querySelector(".material-symbols-outlined");e&&(e.textContent="check_circle")}if(await new Promise(e=>setTimeout(e,500)),b.closeSettingsModal(),b.renderNotesList(),b.updateContextSelectorVisibility(),b.updateBreadcrumbVisibility(),b.updateMarkdownEditorVisibility(),b.updateNewContextButtonVisibility(),S){const t=e.get("contexts");t&&t.length>0&&(g.selectContext(t[0].name),h.setTodayDate(),h.loadNotesList(t[0].name))}}catch(D){if(w.error("Failed to save settings"),o&&(o.textContent="Save"),s&&(s.style.display="none"),n){n.style.display="inline-flex";const e=n.querySelector(".material-symbols-outlined");e&&(e.textContent="check")}}finally{t&&(t.disabled=!1),i&&(i.disabled=!1)}},window.closeOnboardingModal=()=>b.closeOnboardingModal(),window.closeDeleteNoteModal=()=>b.closeDeleteNoteModal(),window.confirmDeleteNote=async()=>{const e=document.getElementById("delete-note-modal");if(!e)return;const t=e.dataset.context,n=e.dataset.date;t&&n&&(b.closeDeleteNoteModal(),await h.deleteNote(t,n))},window.showEditContextModal=t=>{const n=e.get("contexts").find(e=>e.id===t);if(!n)return;const s=document.getElementById("edit-context-modal"),o=document.getElementById("edit-context-name"),i=document.getElementById("edit-context-color-value"),a=document.getElementById("edit-context-colors");if(!(s&&o&&i&&a))return;o.value=n.name;const r=b.normalizeToBulmaColor(n.color);i.value=r,a.innerHTML=["text","link","primary","info","success","warning","danger"].map(e=>{const t=r===e,n=t?"border: 3px solid var(--bulma-text)":"border: 3px solid transparent";return`\n                <button type="button" class="button color-btn ${t?"is-active":""}"\n                        data-color="${e}"\n                        onclick="window.selectEditContextColor('${e}')"\n                        title="${b.getColorLabel(e)}"\n                        style="width: 32px; height: 32px; padding: 3px; ${n}; border-radius: 6px;">\n                    <span style="display: block; width: 100%; height: 100%; background: var(--bulma-${e}); border-radius: 4px;"></span>\n                </button>\n            `}).join(""),s.dataset.contextId=t,s.classList.add("is-active")},window.selectEditContextColor=e=>{const t=document.getElementById("edit-context-color-value");t&&(t.value=e,document.querySelectorAll("#edit-context-colors .color-btn").forEach(t=>{t.dataset.color===e?(t.classList.add("is-active"),t.style.border="3px solid var(--bulma-text)"):(t.classList.remove("is-active"),t.style.border="3px solid transparent")}))},window.closeEditContextModal=()=>{const e=document.getElementById("edit-context-modal");e&&(e.classList.remove("is-active"),delete e.dataset.contextId)},window.confirmEditContext=async()=>{const e=document.getElementById("edit-context-modal");if(!e)return;const t=e.dataset.contextId,n=document.getElementById("edit-context-name"),s=document.getElementById("edit-context-color-value");if(!t||!n||!s)return;const o=n.value.trim(),i=s.value;o?(window.closeEditContextModal(),await g.updateContext(t,o,i),b.renderContextsEditList(),b.renderContextsSelect()):alert("Please enter a context name")},window.showDeleteContextModal=(e,t)=>{const n=document.getElementById("delete-context-modal"),s=document.getElementById("delete-context-name");n&&s&&(s.textContent=t,n.dataset.contextId=e,n.classList.add("is-active"))},window.closeDeleteContextModal=()=>{const e=document.getElementById("delete-context-modal");e&&(e.classList.remove("is-active"),delete e.dataset.contextId)},window.confirmDeleteContext=async()=>{const e=document.getElementById("delete-context-modal");if(!e)return;const t=e.dataset.contextId;t&&(window.closeDeleteContextModal(),await g.deleteContext(t),b.renderContextsEditList(),b.renderContextsSelect())});const x=new class{async init(e){try{await t.init()}catch(n){}if(this.setupEventHandlers(),b.init(),await p.init("markdown-editor-container",e=>{h.handleNoteInput(e)}),await m.checkAuth())await this.showApp();else{const e=document.getElementById("app-section"),t=document.getElementById("auth-section");e&&e.classList.remove("visible"),t&&t.classList.add("visible")}document.body.classList.add("loaded"),m.initGoogleClient(e).catch(e=>{})}setupEventHandlers(){s.on("session-expired",e=>{e.detail.isNoteRequest&&w.warning("Session expired. Your notes are saved locally and will sync when you sign in again.",{title:"Session Expired",duration:1e4})}),s.on(o,e=>{p.setContent(e.detail.content)}),s.on(i,()=>{}),s.on(a,async t=>{const n=t.detail.context;if(p.forceFlush(),await new Promise(e=>setTimeout(e,100)),n){let t=e.get("selectedDate");t||(t=e.get("today")),await h.loadNotesList(n),y.render(),t&&(h.ensureNoteInList(n,t),await h.loadNote(n,t))}else p.setContent("")}),s.on(l,async t=>{const n=t.detail.date,s=e.get("selectedContext");if(p.forceFlush(),await new Promise(e=>setTimeout(e,100)),s){const t=e.get("selectedContext"),o=e.get("selectedDate");if(t!==s||o!==n)return;await h.loadNote(s,n)}}),s.on("auth-success",async()=>{await this.showApp()}),s.on("auth-logout",()=>{p.setContent("")}),s.on(c,e=>{e.detail.message&&w.error(e.detail.message)}),s.on(d,e=>{e.detail.message&&w.success(e.detail.message)})}async showApp(){const t=document.getElementById("landing-loader");t&&t.classList.remove("visible");const n=document.getElementById("app-section"),s=document.getElementById("auth-section");n&&n.classList.add("visible"),s&&s.classList.remove("visible");try{await g.loadContexts(),this.syncServerTime(),h.setTodayDate(),y.render();const t=g.restoreLastContext();if(t){await h.loadNotesList(t);const n=e.get("today");h.ensureNoteInList(t,n),await h.loadNote(t,n)}}catch(o){w.error("Failed to initialize app. Please refresh the page.",{title:"Initialization Error",duration:0})}}async syncServerTime(){try{const t=e.get("userSettings").timezone||"UTC",n=Date.now(),s=1e3*((await u.getServerTime(t)).offset||0),o=s-n+(Date.now()-n)/2;e.set("serverTimeOffset",o)}catch(t){}setTimeout(()=>this.syncServerTime(),6e4)}};window.__APP__=x,"undefined"!=typeof window&&"localhost"===window.location.hostname&&(window.__DEBUG__={app:x,state:e,events:s,notes:h,contexts:g,calendar:y,auth:m,api:u,cache:t,markdownEditor:p,notifications:w,ui:b}),(async()=>{await new Promise(e=>setTimeout(e,0));const e=document.querySelector('meta[name="google-client-id"]'),t=e?.getAttribute("content")||window.__GOOGLE_CLIENT_ID__;t&&await x.init(t)})()}}});
//# sourceMappingURL=main-legacy-DON0QWmt.js.map
