var e=Object.defineProperty,t=(t,n,o)=>((t,n,o)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[n]=o)(t,"symbol"!=typeof n?n+"":n,o);function n(){import.meta.url,import("_").catch(()=>1),async function*(){}().next()}import{s as o,e as s,E as i,c as a,S as l}from"./utils-Cl-bO8oY.js";const c=new class{async request(e,t={}){try{const n=await fetch(e,{...t,headers:{...t.headers,"Content-Type":"application/json"},credentials:"same-origin"});if(!n.ok){const t=await n.json().catch(()=>({}));if(401===n.status||403===n.status){if(!o.get("isLoggingOut")){const t=e.includes("/api/notes"),n=t?"Session expired. Your notes are saved locally and will sync when you sign in again.":"Session expired. Please login again.";s.emit(i.SHOW_ERROR,{message:n}),s.emit("session-expired",{isNoteRequest:t})}throw o.set("currentUser",null),new Error("Session expired")}throw new Error(t.error||"Request failed with status ".concat(n.status))}return await n.json()}catch(n){throw o.get("isLoggingOut")||n instanceof Error&&!n.message.includes("Session expired")&&s.emit(i.SHOW_ERROR,{message:n.message||"An error occurred"}),n}}async checkAuth(){try{const e=await fetch("/api/auth/me");return await e.json()}catch(e){return console.error("Auth check failed:",e),{authenticated:!1}}}async login(e,t){return await this.request("/api/auth/login",{method:"POST",body:JSON.stringify({access_token:e,expires_in:t||3600})})}async loginWithCode(e){return await this.request("/api/auth/login",{method:"POST",body:JSON.stringify({code:e})})}async logout(){await this.request("/api/auth/logout",{method:"POST"})}async getContexts(){return await this.request("/api/contexts")}async createContext(e){return await this.request("/api/contexts",{method:"POST",body:JSON.stringify(e)})}async updateContext(e,t){return await this.request("/api/contexts/".concat(e),{method:"PUT",body:JSON.stringify(t)})}async deleteContext(e){await this.request("/api/contexts/".concat(e),{method:"DELETE"})}async getNote(e,t){return await this.request("/api/notes?context=".concat(encodeURIComponent(e),"&date=").concat(t))}async saveNote(e){return await this.request("/api/notes",{method:"POST",body:JSON.stringify(e)})}async getNotesList(e,t=50,n=0){return await this.request("/api/notes/list?context=".concat(encodeURIComponent(e),"&limit=").concat(t,"&offset=").concat(n))}async deleteNote(e,t){const n=encodeURIComponent(e),o=encodeURIComponent(t);await this.request("/api/notes/".concat(n,"/").concat(o),{method:"DELETE"})}async updateSettings(e){return await this.request("/api/settings",{method:"PUT",body:JSON.stringify(e)})}async getServerTime(e){const t=await fetch("/api/time?timezone=".concat(encodeURIComponent(e)));return await t.json()}};const r=new class{constructor(){t(this,"codeClient",null),t(this,"initializationPromise",null)}async checkAuth(){const e=await c.checkAuth();return!(!e.authenticated||!e.user)&&(o.update({currentUser:e.user,userSettings:e.user.settings||{theme:"dark",weekStart:0,timezone:"UTC",dateFormat:"DD-MM-YY",uniqueContextMode:!1,showBreadcrumb:!1,showMarkdownEditor:!1,hideNewContextButton:!1}}),!0)}async initGoogleClient(e){return this.initializationPromise?this.initializationPromise:this.codeClient?Promise.resolve():(this.initializationPromise=new Promise((t,n)=>{const o=()=>{var s,i;if(null==(i=null==(s=window.google)?void 0:s.accounts)?void 0:i.oauth2)try{this.codeClient=window.google.accounts.oauth2.initCodeClient({client_id:e,scope:"https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.email",ux_mode:"popup",callback:e=>this.handleAuthCodeResponse(e)}),console.log("[AUTH] Google code client initialized successfully"),t()}catch(a){console.error("[AUTH] Failed to initialize Google client:",a),n(a)}else setTimeout(o,100)};o(),setTimeout(()=>{this.codeClient||n(new Error("Google API failed to load within timeout"))},1e4)}),this.initializationPromise)}async handleAuthCodeResponse(e){const t=document.getElementById("landing-loader");if(e.error)return t&&t.classList.remove("visible"),void s.emit(i.SHOW_ERROR,{message:"OAuth failed: "+e.error});if(!e.code)return t&&t.classList.remove("visible"),void s.emit(i.SHOW_ERROR,{message:"OAuth failed: No code received"});try{const n=await c.loginWithCode(e.code);n.success&&n.user?(console.log("[AUTH] Login successful, updating state"),console.log("[AUTH] Received hasNoContexts:",n.user.hasNoContexts),o.update({currentUser:n.user,hasNoContexts:n.user.hasNoContexts||!1,userSettings:n.user.settings||{theme:"dark",weekStart:0,timezone:"UTC",dateFormat:"DD-MM-YY",uniqueContextMode:!1,showBreadcrumb:!1,showMarkdownEditor:!1,hideNewContextButton:!1}}),console.log("[AUTH] Emitting auth-success event"),s.emit("auth-success",{})):(t&&t.classList.remove("visible"),s.emit(i.SHOW_ERROR,{message:n.error||"Login failed"}))}catch(n){t&&t.classList.remove("visible");const e=n instanceof Error?n.message:"Unknown error";s.emit(i.SHOW_ERROR,{message:"Login failed: "+e})}}async signIn(){const e=document.getElementById("landing-loader");e&&e.classList.add("visible");try{if(await this.initializationPromise,!this.codeClient)throw new Error("Google client not initialized");this.codeClient.requestCode()}catch(t){console.error("[AUTH] Sign in failed:",t),e&&e.classList.remove("visible"),s.emit(i.SHOW_ERROR,{message:"Failed to initialize Google sign-in. Please refresh the page."})}}signOut(){console.log("[AUTH] Starting logout...");try{localStorage.clear(),sessionStorage.clear(),console.log("[AUTH] Client storage cleared")}catch(e){console.error("[AUTH] Storage clear error:",e)}console.log("[AUTH] Navigating to logout endpoint..."),window.location.href="/api/auth/logout"}async clearAllCaches(){try{const e="DailyNotesDB",t=indexedDB.deleteDatabase(e);if(await new Promise(e=>{t.onsuccess=()=>{console.log("[AUTH] IndexedDB cleared"),e()},t.onerror=()=>{console.warn("[AUTH] Failed to clear IndexedDB"),e()}}),"caches"in window){const e=await caches.keys();await Promise.all(e.map(e=>(console.log("[AUTH] Deleting cache:",e),caches.delete(e)))),console.log("[AUTH] All Service Worker caches cleared")}if("serviceWorker"in navigator){const e=await navigator.serviceWorker.getRegistrations();await Promise.all(e.map(e=>(console.log("[AUTH] Unregistering service worker"),e.unregister()))),console.log("[AUTH] All service workers unregistered")}document.cookie.split(";").forEach(e=>{const t=e.indexOf("="),n=t>-1?e.substring(0,t).trim():e.trim();document.cookie="".concat(n,"=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/"),document.cookie="".concat(n,"=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=").concat(window.location.hostname)}),console.log("[AUTH] Cookies cleared"),localStorage.clear(),sessionStorage.clear(),console.log("[AUTH] Storage cleared")}catch(e){console.error("[AUTH] Error clearing caches:",e)}}};"undefined"!=typeof window&&(window.signInWithGoogle=()=>r.signIn());const d=new class{constructor(){t(this,"saveTimeout",null),t(this,"currentNoteContent",""),t(this,"currentLoadToken",0),t(this,"currentSelectToken",0)}async loadNote(e,t){if(!e||!t)return null;const n=++this.currentLoadToken;console.log("[Notes] loadNote started - token: ".concat(n,", context: ").concat(e,", date: ").concat(t));const o=await a.getNote(e,t);if(n!==this.currentLoadToken)return console.log("[Notes] Load cancelled (cache) - token ".concat(n," is stale")),null;o&&o.content?(this.currentNoteContent=o.content,s.emit(i.NOTE_LOADED,{context:e,date:t,content:this.currentNoteContent})):(this.currentNoteContent="",s.emit(i.NOTE_LOADED,{context:e,date:t,content:""}));try{const{note:l}=await c.getNote(e,t);if(n!==this.currentLoadToken)return console.log("[Notes] Load cancelled (server) - token ".concat(n," is stale")),null;const r=l.updated_at?new Date(l.updated_at).getTime():0,d=(null==o?void 0:o.updated_at)?new Date(o.updated_at).getTime():0;return!o||r>d||l.content&&!o.content?(this.currentNoteContent=l.content||"",await a.saveNote({...l,context:e,date:t,content:l.content,updated_at:l.updated_at}),o&&o.content===l.content||s.emit(i.NOTE_LOADED,{context:e,date:t,content:this.currentNoteContent})):console.log("[Notes] Cache is newer than server, keeping cached version"),l}catch(l){return n!==this.currentLoadToken?(console.log("[Notes] Load cancelled (error) - token ".concat(n," is stale")),null):(o?console.warn("[Notes] Server unavailable, using cached version"):(console.error("Failed to load note:",l),s.emit(i.SHOW_ERROR,{message:"Failed to load note. Working offline."})),o)}}async saveNote(e,t,n){if(!e||!t)return;console.log("[Notes] saveNote called - context: ".concat(e,", date: ").concat(t,", content length: ").concat(n.length));const o=(new Date).toISOString(),l={context:e,date:t,content:n,updated_at:o};await a.saveNote(l),this.currentNoteContent=n,console.log("[Notes] Saved to cache and updated currentNoteContent"),s.emit(i.NOTE_SAVED,{context:e,date:t,content:n}),this.updateNoteInList(e,t,n),console.log("[Notes] Syncing to server - content length: ".concat(n.length));try{await c.saveNote({context:e,date:t,content:n,updated_at:o}),console.log("[Notes] Successfully synced to server")}catch(r){console.error("[Notes] Failed to sync to server:",r)}}async loadNotesList(e,t=50,n=0){if(!e)return o.update({notes:[],notesWithDates:[]}),[];try{const s=(await c.getNotesList(e,t,n)).notes||[],i=await a.getNotesByContext(e),l=new Map;s.forEach(e=>{l.set(e.date,e)}),i.forEach(e=>{l.has(e.date)||l.set(e.date,e)});const r=Array.from(l.values()).sort((e,t)=>t.date.localeCompare(e.date)),d=r.map(e=>e.date);return o.update({notes:r,notesWithDates:d}),r}catch(s){return console.error("Failed to load notes list:",s),[]}}async refreshNotesList(e){await this.loadNotesList(e)}updateNoteInList(e,t,n){const s=o.get("notes").map(o=>o.date===t&&o.context===e?{...o,content:n,updated_at:(new Date).toISOString()}:o);o.set("notes",s)}ensureNoteInList(e,t){var n;const s=o.get("notes"),i=o.get("notesWithDates");if(!s.some(e=>e.date===t)){const a={id:"temp-".concat(e,"-").concat(t),user_id:(null==(n=o.get("currentUser"))?void 0:n.id)||"",context:e,date:t,content:"",created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()},l=[...s,a].sort((e,t)=>t.date.localeCompare(e.date)),c=[...i,t];o.update({notes:l,notesWithDates:c})}}handleNoteInput(e){this.saveTimeout&&clearTimeout(this.saveTimeout),this.currentNoteContent=e;const t=o.get("selectedContext"),n=o.get("selectedDate");t&&n&&(this.saveTimeout=window.setTimeout(()=>{const e=o.get("selectedContext"),s=o.get("selectedDate");e===t&&s===n?(console.log("[Notes] Saving note - context: ".concat(t,", date: ").concat(n)),this.saveNote(t,n,this.currentNoteContent)):console.log("[Notes] Save cancelled - context/date changed from ".concat(t,"/").concat(n," to ").concat(e,"/").concat(s))},500))}async selectDate(e){const t=++this.currentSelectToken;console.log("[Notes] selectDate started - token: ".concat(t,", date: ").concat(e));const n=o.get("selectedContext"),a=e.split("-"),l=parseInt(a[0]),c=parseInt(a[1])-1;if(o.update({selectedDate:e,currentCalendarMonth:c,currentCalendarYear:l}),t===this.currentSelectToken){if(s.emit(i.DATE_CHANGED,{date:e}),n){if(t!==this.currentSelectToken)return void console.log("[Notes] selectDate cancelled before load - token ".concat(t," is stale"));this.ensureNoteInList(n,e),await this.loadNote(n,e)}}else console.log("[Notes] selectDate cancelled - token ".concat(t," is stale"))}setTodayDate(){const e=o.get("today"),[t,n]=e.split("-").map(Number);o.update({selectedDate:e,currentCalendarMonth:n-1,currentCalendarYear:t})}getCurrentNoteContent(){return this.currentNoteContent}async deleteNote(e,t){if(!e||!t)return;console.log("[Notes] Deleting note - context: ".concat(e,", date: ").concat(t)),this.saveTimeout&&(clearTimeout(this.saveTimeout),this.saveTimeout=null,console.log("[Notes] Cancelled pending save operation")),await a.deleteNote(e,t);const n=o.get("notes").filter(n=>!(n.date===t&&n.context===e)),l=o.get("notesWithDates").filter(e=>e!==t);o.update({notes:n,notesWithDates:l});if(o.get("selectedDate")===t)if(this.currentNoteContent="",n.length>0){const e=n[0];await this.selectDate(e.date)}else this.setTodayDate(),s.emit(i.NOTE_LOADED,{context:e,date:t,content:""});try{await c.deleteNote(e,t),console.log("[Notes] Note deleted from server")}catch(r){console.error("[Notes] Failed to delete note from server:",r)}console.log("[Notes] Note deleted locally and synced")}};const u=new class{async loadContexts(){const e=await a.getContexts();console.log("[CONTEXTS] Cached contexts:",e),e.length>0&&o.set("contexts",e);try{console.log("[CONTEXTS] Fetching contexts from server...");const e=await c.getContexts();console.log("[CONTEXTS] Server response:",e);const t=(null==e?void 0:e.contexts)||[];console.log("[CONTEXTS] Parsed contexts:",t),await a.saveContexts(t),o.set("contexts",t),s.emit(i.CONTEXTS_LOADED,{contexts:t})}catch(t){console.error("[CONTEXTS] Failed to load contexts from server:",t),0!==e.length||navigator.onLine||s.emit(i.SHOW_ERROR,{message:"Failed to load contexts. Working offline."})}}async createContext(e,t){var n;const s={id:"temp-".concat(Date.now()),user_id:(null==(n=o.get("currentUser"))?void 0:n.id)||"",name:e,color:t||"primary",created_at:(new Date).toISOString()},i=[...o.get("contexts"),s];await a.saveContexts(i),o.set("contexts",i),o.set("selectedContext",e);try{await c.createContext({name:e,color:t}),console.log("[CONTEXTS] Successfully synced new context to server"),await this.loadContexts()}catch(l){console.error("[CONTEXTS] Failed to sync context to server:",l)}return s}async updateContext(e,t,n){try{await c.updateContext(e,{name:t,color:n});const l=o.get("contexts"),r=l.map(o=>o.id===e?{...o,name:t,color:n}:o);await a.saveContexts(r),o.set("contexts",r);const d=o.get("selectedContext"),u=l.find(t=>t.id===e);return d===(null==u?void 0:u.name)&&(o.set("selectedContext",t),localStorage.setItem("lastContext",t)),s.emit(i.SHOW_SUCCESS,{message:"Context updated successfully"}),!0}catch(l){return s.emit(i.SHOW_ERROR,{message:"Failed to update context"}),!1}}async deleteContext(e){try{await c.deleteContext(e);const t=o.get("contexts").filter(t=>t.id!==e);await a.saveContexts(t),o.set("contexts",t),s.emit(i.SHOW_SUCCESS,{message:"Context deleted successfully"})}catch(t){s.emit(i.SHOW_ERROR,{message:"Failed to delete context"})}}selectContext(e){o.set("selectedContext",e),s.emit(i.CONTEXT_CHANGED,{context:e}),e&&localStorage.setItem("lastContext",e)}getSelectedContext(){return o.get("selectedContext")}getContextColor(e){const t=o.get("contexts").find(t=>t.name===e),n=(null==t?void 0:t.color)||"primary";return["text","link","primary","info","success","warning","danger"].includes(n)?n:"primary"}restoreLastContext(){const e=o.get("contexts"),t=o.get("userSettings").uniqueContextMode||!1;if(console.log("[CONTEXTS] restoreLastContext - contexts:",e),console.log("[CONTEXTS] uniqueContextMode:",t),!e||0===e.length)return console.log("[CONTEXTS] No contexts available"),null;if(t){const t=e[0].name;return console.log("[CONTEXTS] Unique context mode - selecting first context:",t),this.selectContext(t),t}const n=localStorage.getItem("lastContext");if(console.log("[CONTEXTS] lastContext from localStorage:",n),n){const t=e.some(e=>e.name===n);if(console.log("[CONTEXTS] lastContext exists?",t),t)return console.log("[CONTEXTS] Selecting last context:",n),this.selectContext(n),n}const s=e[0].name;return console.log("[CONTEXTS] Selecting first context:",s),this.selectContext(s),s}};const m=new class{constructor(){t(this,"monthNames",["January","February","March","April","May","June","July","August","September","October","November","December"]),t(this,"dayNamesDefault",["Sun","Mon","Tue","Wed","Thu","Fri","Sat"])}render(){const e=o.get("userSettings").weekStart||0,t=o.get("currentCalendarMonth"),n=o.get("currentCalendarYear"),s=o.get("selectedDate"),i=o.get("today"),a=o.get("notesWithDates"),l=[...this.dayNamesDefault.slice(e),...this.dayNamesDefault.slice(0,e)],c=document.getElementById("calendar-month-year");c&&(c.textContent="".concat(this.monthNames[t]," ").concat(n));const r=(new Date(n,t,1).getDay()-e+7)%7,u=new Date(n,t+1,0).getDate(),m=new Date(n,t,0).getDate(),h=document.getElementById("calendar-grid");if(!h)return;let g=l.map(e=>'<div class="calendar-day-header">'.concat(e,"</div>")).join("");for(let o=r-1;o>=0;o--){g+='<div class="calendar-day other-month">'.concat(m-o,"</div>")}for(let o=1;o<=u;o++){const e="".concat(n,"-").concat(String(t+1).padStart(2,"0"),"-").concat(String(o).padStart(2,"0")),l=["calendar-day"];e===i&&l.push("today"),e===s&&l.push("selected"),a.includes(e)&&l.push("has-note"),g+='<div class="'.concat(l.join(" "),'" data-date="').concat(e,'">').concat(o,"</div>")}const y=r+u,p=y%7==0?0:7-y%7;for(let o=1;o<=p;o++)g+='<div class="calendar-day other-month">'.concat(o,"</div>");h.innerHTML=g,h.querySelectorAll(".calendar-day:not(.other-month)").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.date;t&&d.selectDate(t)})})}prevMonth(){let e=o.get("currentCalendarMonth"),t=o.get("currentCalendarYear");e--,e<0&&(e=11,t--),o.update({currentCalendarMonth:e,currentCalendarYear:t}),this.render()}nextMonth(){let e=o.get("currentCalendarMonth"),t=o.get("currentCalendarYear");e++,e>11&&(e=0,t++),o.update({currentCalendarMonth:e,currentCalendarYear:t}),this.render()}goToToday(){const e=o.get("today");d.selectDate(e)}};const h=new class{constructor(){t(this,"container",null),t(this,"editor",null),t(this,"editorElement",null),t(this,"onChangeCallback",null),t(this,"isUpdating",!1),t(this,"currentNoteContent",""),t(this,"updateTimeout",null),t(this,"contentVersion",0)}async init(e,t){this.container=document.getElementById(e),this.container?(this.onChangeCallback=t,this.container.innerHTML='<div style="padding: 1rem; color: var(--bulma-text-light); opacity: 0.6;">Editor loading...</div>'):console.error("[MarkdownEditor] Container not found:",e)}async ensureQuillLoaded(){this.editor||(await this.loadQuill(),this.render(),this.initQuill())}async loadQuill(){if(window.Quill)return;const e=document.createElement("link");e.rel="stylesheet",e.href="/static/vendor/quill/quill.snow.css",document.head.appendChild(e);const t=document.createElement("script");t.src="/static/vendor/quill/quill.min.js",document.head.appendChild(t),await new Promise(e=>{t.onload=()=>e()})}render(){this.container&&(this.container.innerHTML='\n      <div class="quill-editor-wrapper">\n        <div id="quill-editor"></div>\n      </div>\n    ',this.editorElement=document.getElementById("quill-editor"))}initQuill(){if(window.Quill)try{this.editor=new window.Quill(this.editorElement,{theme:"snow",modules:{toolbar:[[{header:[1,2,3,!1]}],["bold","italic"],[{list:"bullet"}],["blockquote","code-block"],["link"]]},placeholder:"Start writing your notes...",formats:["bold","italic","header","list","code-block","blockquote","link"]}),this.editor.on("text-change",()=>{if(!this.isUpdating&&this.onChangeCallback){const e=this.getMarkdown();this.onChangeCallback(e)}}),this.editor.root.addEventListener("focus",()=>{""===this.editor.getText().trim()&&(this.editor.root.dataset.placeholder="")}),this.editor.root.addEventListener("blur",()=>{""===this.editor.getText().trim()&&(this.editor.root.dataset.placeholder="Start writing your notes...")}),this.applyToolbarVisibility()}catch(e){console.error("[MarkdownEditor] Error initializing editor:",e)}else console.error("[MarkdownEditor] Quill not loaded")}applyToolbarVisibility(){var e;const t=!0===o.get("userSettings").showMarkdownEditor,n=null==(e=this.container)?void 0:e.querySelector(".ql-toolbar");if(n&&(n.style.display=t?"":"none"),this.editor){const e=o.get("selectedContext");this.editor.enable(!!e)}}getMarkdown(){if(!this.editor)return"";const e=this.editor.getContents();let t="",n=null,o=0;return e.ops.forEach(e=>{if(!e.insert)return;const s="string"==typeof e.insert?e.insert:"",i=e.attributes||{};if("\n"===s)if(i.header)t=t.trimEnd(),t="#".repeat(i.header)+" "+t.split("\n").pop(),t+="\n\n";else if(i.list){i.list!==n&&(n=i.list,o=1);const e=t.split("\n").pop();t=t.substring(0,t.lastIndexOf("\n")+1),"ordered"===i.list?t+="".concat(o++,". ").concat(e,"\n"):"bullet"===i.list?t+="- ".concat(e,"\n"):"check"===i.list&&(t+="- [ ] ".concat(e,"\n"))}else if(n=null,o=0,i.blockquote){const e=t.split("\n").pop();t=t.substring(0,t.lastIndexOf("\n")+1),t+="> ".concat(e,"\n")}else i["code-block"]?t+="\n```\n":t+="\n";else{let e=s;i.bold&&(e="**".concat(e,"**")),i.italic&&(e="*".concat(e,"*")),i.strike&&(e="~~".concat(e,"~~")),i.code&&(e="`".concat(e,"`")),i.link&&(e="[".concat(e,"](").concat(i.link,")")),t+=e}}),t.trim()}async setContent(e){if(await this.ensureQuillLoaded(),!this.editor)return;this.contentVersion++;const t=this.contentVersion;console.log("[Editor] setContent called - version:",t,"content length:",e.length),this.updateTimeout&&(clearTimeout(this.updateTimeout),this.updateTimeout=null),this.editor.disable(),this.isUpdating=!0;try{if(e){const t=this.markdownToDelta(e);this.editor.setContents(t),this.currentNoteContent=e}else this.editor.setText(""),this.currentNoteContent=""}finally{this.updateTimeout=window.setTimeout(()=>{console.log("[Editor] Unlocking editor - version:",t),this.isUpdating=!1,this.updateTimeout=null;o.get("selectedContext")&&this.editor&&this.editor.enable(!0)},600)}}markdownToDelta(e){const t=[],n=e.split("\n");return n.forEach((e,o)=>{const s=e.match(/^(#{1,3})\s+(.+)$/);if(s){const e=s[1].length;return t.push({insert:s[2]}),void t.push({insert:"\n",attributes:{header:e}})}const i=e.match(/^-\s+(.+)$/);if(i){const e=this.parseInlineMarkdown(i[1]);return t.push(...e),void t.push({insert:"\n",attributes:{list:"bullet"}})}const a=e.match(/^\d+\.\s+(.+)$/);if(a){const e=this.parseInlineMarkdown(a[1]);return t.push(...e),void t.push({insert:"\n",attributes:{list:"ordered"}})}const l=e.match(/^-\s+\[([ x])\]\s+(.+)$/);if(l){const e=this.parseInlineMarkdown(l[2]);return t.push(...e),void t.push({insert:"\n",attributes:{list:"check"}})}const c=e.match(/^>\s+(.+)$/);if(c){const e=this.parseInlineMarkdown(c[1]);return t.push(...e),void t.push({insert:"\n",attributes:{blockquote:!0}})}if(e.startsWith("```"))t.push({insert:"\n",attributes:{"code-block":!0}});else{if(e.trim()){const n=this.parseInlineMarkdown(e);t.push(...n)}o<n.length-1&&t.push({insert:"\n"})}}),{ops:t}}parseInlineMarkdown(e){const t=[],n=/(\*\*([^*]+)\*\*)|(\*([^*]+)\*)|(~~([^~]+)~~)|(`([^`]+)`)|(\[([^\]]+)\]\(([^)]+)\))/g;let o,s=0;for(;null!==(o=n.exec(e));)o.index>s&&t.push({insert:e.substring(s,o.index)}),o[1]?t.push({insert:o[2],attributes:{bold:!0}}):o[3]?t.push({insert:o[4],attributes:{italic:!0}}):o[5]?t.push({insert:o[6],attributes:{strike:!0}}):o[7]?t.push({insert:o[8],attributes:{code:!0}}):o[9]&&t.push({insert:o[10],attributes:{link:o[11]}}),s=n.lastIndex;return s<e.length&&t.push({insert:e.substring(s)}),t.length>0?t:[{insert:e}]}getContent(){return this.getMarkdown()}async setDisabled(e){var t;if(e||await this.ensureQuillLoaded(),!this.editor)return;this.editor.enable(!e);const n=null==(t=this.container)?void 0:t.querySelector(".ql-toolbar");n&&(n.style.pointerEvents=e?"none":"auto",n.style.opacity=e?"0.5":"1");const o=this.editor.root;o&&e?o.dataset.placeholder="Select a context to start writing...":o&&(o.dataset.placeholder="Start writing your notes...")}setPlaceholderMessage(e){this.ensureQuillLoaded().then(()=>{if(!this.editor)return;const t=this.editor.root;t&&(t.dataset.placeholder=e)})}focus(){this.editor&&this.editor.focus()}forceFlush(){if(!this.editor||this.isUpdating)return;const e=this.getMarkdown();this.onChangeCallback&&this.onChangeCallback(e)}hasPendingChanges(){if(!this.editor)return!1;return this.getMarkdown()!==this.currentNoteContent}};const g=new class{constructor(){t(this,"container"),t(this,"notifications",new Map),t(this,"queue",[]),t(this,"maxVisible",3),t(this,"defaultDuration",5e3),this.container=this.init()}init(){const e=document.createElement("div");return e.id="notification-container",e.className="notification-container",e.setAttribute("role","region"),e.setAttribute("aria-label","Notifications"),document.body.appendChild(e),e}show(e){const{type:t="info",title:n,message:o,duration:s=this.defaultDuration,dismissible:i=!0,onAction:a,actionLabel:l="Action"}=e,c="notification-".concat(Date.now(),"-").concat(Math.random()),r={id:c,type:t,title:n,message:o,duration:s,dismissible:i,onAction:a,actionLabel:l,element:null};return this.container.children.length>=this.maxVisible?(this.queue.push(r),c):(this.render(r),c)}render(e){const{id:t,type:n,title:o,message:s,duration:i,dismissible:a,onAction:l,actionLabel:c}=e,r=document.createElement("div");r.className="notification-toast notification-".concat(n),r.setAttribute("role","alert"),r.setAttribute("aria-live","error"===n?"assertive":"polite"),r.dataset.id=t;if(r.innerHTML='\n      <div class="notification-icon">\n        <span class="material-symbols-outlined">'.concat({success:"check_circle",error:"error",warning:"warning",info:"info"}[n],'</span>\n      </div>\n      <div class="notification-content">\n        ').concat(o?'<div class="notification-title">'.concat(this.escapeHtml(o),"</div>"):"",'\n        <div class="notification-message">').concat(this.escapeHtml(s),"</div>\n      </div>\n      ").concat(l?'\n        <button class="notification-action" aria-label="'.concat(c,'">\n          ').concat(c,"\n        </button>\n      "):"","\n      ").concat(a?'\n        <button class="notification-close" aria-label="Close notification">\n          <span class="material-symbols-outlined">close</span>\n        </button>\n      ':"","\n    "),a){const e=r.querySelector(".notification-close");null==e||e.addEventListener("click",()=>this.dismiss(t))}if(l){const e=r.querySelector(".notification-action");null==e||e.addEventListener("click",()=>{l(),this.dismiss(t)})}this.container.appendChild(r),e.element=r,this.notifications.set(t,e),requestAnimationFrame(()=>{r.classList.add("notification-visible")}),i&&i>0&&(e.timeout=window.setTimeout(()=>{this.dismiss(t)},i))}dismiss(e){const t=this.notifications.get(e);if(!t)return;const{element:n,timeout:o}=t;o&&clearTimeout(o),null==n||n.classList.remove("notification-visible"),null==n||n.classList.add("notification-hiding"),setTimeout(()=>{(null==n?void 0:n.parentNode)&&n.parentNode.removeChild(n),this.notifications.delete(e),this.processQueue()},300)}processQueue(){const e=this.container.children.length;if(this.queue.length>0&&e<this.maxVisible){const e=this.queue.shift();e&&this.render(e)}}success(e,t={}){return this.show({type:"success",message:e,title:"Success",...t})}error(e,t={}){return this.show({type:"error",message:e,title:"Error",duration:7e3,...t})}warning(e,t={}){return this.show({type:"warning",message:e,title:"Warning",...t})}info(e,t={}){return this.show({type:"info",message:e,...t})}clearAll(){this.notifications.forEach(e=>{this.dismiss(e.id)}),this.queue=[]}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}};function y(e){if(["text","link","primary","info","success","warning","danger"].includes(e))return e;return{"#485fc7":"primary","#3e8ed0":"info","#48c78e":"success","#ffe08a":"warning","#f14668":"danger"}[e]||"primary"}const p=new class{constructor(){t(this,"elements"),t(this,"lastKnownDate"),t(this,"INITIAL_RENDER_COUNT"),t(this,"renderedNotesCount"),t(this,"clockStarted"),this.elements={},this.lastKnownDate=null,this.INITIAL_RENDER_COUNT=50,this.renderedNotesCount=this.INITIAL_RENDER_COUNT,this.clockStarted=!1}init(){this.elements={authSection:document.getElementById("auth-section"),appSection:document.getElementById("app-section"),contextSelect:document.getElementById("context-select"),contextColorIndicator:document.getElementById("context-color-indicator"),mobileContextSelect:document.getElementById("mobile-context-select"),mobileContextColorIndicator:document.getElementById("mobile-context-color-indicator"),datePicker:document.getElementById("date-picker"),breadcrumbContextName:document.getElementById("breadcrumb-context-name"),breadcrumbDateName:document.getElementById("breadcrumb-date-name"),markdownEditorContainer:document.getElementById("markdown-editor-container"),saveIndicator:document.getElementById("save-indicator"),notesList:document.getElementById("notes-list"),userEmail:document.getElementById("user-email"),currentTime:document.getElementById("current-time"),currentDate:document.getElementById("current-date"),mobileCurrentTime:document.getElementById("mobile-current-time"),mobileCurrentDate:document.getElementById("mobile-current-date"),mobileSelectedNoteDate:document.getElementById("mobile-selected-note-date"),contextModal:document.getElementById("context-modal"),settingsModal:document.getElementById("settings-modal"),onboardingModal:document.getElementById("onboarding-modal"),syncStatus:document.getElementById("sync-status"),syncStatusText:document.getElementById("sync-status-text"),themeToggleMenu:document.getElementById("theme-toggle-menu"),themeToggleSwitch:document.getElementById("theme-toggle-switch"),weekStartSelect:document.getElementById("week-start-select"),timezoneSelect:document.getElementById("timezone-select"),mobileNotesToggle:document.getElementById("mobile-notes-toggle"),mobileCalendarToggle:document.getElementById("mobile-calendar-toggle"),sidebar:document.querySelector(".sidebar"),calendarPanel:document.querySelector(".calendar-panel"),sidebarOverlay:document.getElementById("sidebar-overlay"),calendarOverlay:document.getElementById("calendar-overlay"),sidebarClose:document.getElementById("sidebar-close"),calendarClose:document.getElementById("calendar-close")},this.setupEventListeners(),this.setupStateSubscriptions(),this.setupUserDropdown(),this.setupMobileNavigation()}setupEventListeners(){var e,t,n,s,i,a,l;const r=document.getElementById("editor-fullscreen-btn");r&&r.addEventListener("click",()=>{this.openFullscreenNote()});const h=document.getElementById("editor-delete-note-btn");h&&h.addEventListener("click",()=>{const e=o.get("selectedContext"),t=o.get("selectedDate");if(e&&t){const n=o.get("userSettings"),s=n.timezone||"UTC",i=n.dateFormat||"DD-MM-YY",[a,l,c]=t.split("-").map(Number),r=new Date(a,l-1,c).toLocaleDateString("en-US",{weekday:"long",timeZone:s}),d=String(a).substring(2),u=String(l).padStart(2,"0"),m=String(c).padStart(2,"0");let h;h="MM-DD-YY"===i?"".concat(u,"-").concat(m,"-").concat(d):"".concat(m,"-").concat(u,"-").concat(d);const g="".concat(r,", ").concat(h);this.showDeleteNoteModal(e,t,g)}}),null==(e=this.elements.contextSelect)||e.addEventListener("change",e=>{const t=e.target.value;console.log("[UI] Desktop context selector changed:",t),u.selectContext(t)}),null==(t=this.elements.mobileContextSelect)||t.addEventListener("change",e=>{const t=e.target.value;console.log("[UI] Mobile context selector changed:",t),u.selectContext(t)}),null==(n=this.elements.datePicker)||n.addEventListener("change",async e=>{const t=e.target.value;o.get("selectedDate")!==t?await d.selectDate(t):console.log("[UI] Date picker: date already selected, skipping:",t)}),null==(s=document.getElementById("prev-month"))||s.addEventListener("click",()=>{m.prevMonth()}),null==(i=document.getElementById("next-month"))||i.addEventListener("click",()=>{m.nextMonth()}),null==(a=this.elements.themeToggleMenu)||a.addEventListener("click",async e=>{e.preventDefault();const t="dark"===document.documentElement.getAttribute("data-theme")?"light":"dark";this.setTheme(t);const n=o.get("userSettings");o.set("userSettings",{...n,theme:t});try{await c.updateSettings({...n,theme:t})}catch(s){console.error("Failed to save theme:",s)}}),null==(l=this.elements.themeToggleSwitch)||l.addEventListener("change",e=>{this.setTheme(e.target.checked?"dark":"light")}),this.setupKeyboardShortcuts()}setupKeyboardShortcuts(){document.addEventListener("keydown",e=>{var t;const n=navigator.platform.toUpperCase().indexOf("MAC")>=0?e.metaKey:e.ctrlKey;if(n&&"k"===e.key)return e.preventDefault(),void(null==(t=this.elements.contextSelect)||t.focus());if(n&&"s"===e.key)return e.preventDefault(),void s.emit("sync-force",void 0);if(n&&"/"===e.key)e.preventDefault();else if("Escape"===e.key){const e=document.getElementById("delete-note-modal");return(null==e?void 0:e.classList.contains("is-active"))?void this.closeDeleteNoteModal():void this.closeAllModals()}})}setupUserDropdown(){const e=document.getElementById("user-dropdown"),t=document.getElementById("user-dropdown-button"),n=document.getElementById("settings-menu-item"),o=document.getElementById("signout-menu-item");e&&t&&(t.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),e.classList.toggle("is-active")}),null==n||n.addEventListener("click",t=>{t.preventDefault(),e.classList.remove("is-active"),this.showSettingsModal()}),null==o||o.addEventListener("click",t=>{t.preventDefault(),e.classList.remove("is-active"),r.signOut()}),document.addEventListener("click",t=>{e.contains(t.target)||e.classList.remove("is-active")}),document.addEventListener("keydown",t=>{"Escape"===t.key&&e.classList.contains("is-active")&&e.classList.remove("is-active")}))}setupStateSubscriptions(){o.subscribe("contexts",()=>{this.renderContextsSelect()}),o.subscribeMany(["currentCalendarMonth","currentCalendarYear"],()=>{m.render()}),o.subscribe("notes",()=>{this.renderNotesList(),m.render()}),o.subscribe("selectedContext",e=>{this.updateBreadcrumb(),this.renderedNotesCount=this.INITIAL_RENDER_COUNT}),o.subscribe("selectedDate",e=>{this.elements.datePicker&&e&&(this.elements.datePicker.value=e,this.updateDatePickerDisplay(e)),this.renderNotesList(),m.render(),this.updateBreadcrumb(),this.updateEditorDeleteButton()}),o.subscribe("userSettings",()=>{const e=o.get("selectedDate");e&&this.updateDatePickerDisplay(e),this.updateBreadcrumb()}),o.subscribe("selectedContext",e=>{this.elements.contextSelect&&e&&(this.elements.contextSelect.value=e),this.elements.mobileContextSelect&&e&&(this.elements.mobileContextSelect.value=e),this.updateContextIndicator(),this.updateEditorState()}),o.subscribe("currentUser",e=>{this.elements.userEmail&&e&&(this.elements.userEmail.textContent=e.email||"")}),o.subscribe("userSettings",e=>{e.theme&&this.setTheme(e.theme),this.updateContextSelectorVisibility(),this.updateBreadcrumbVisibility(),this.updateMarkdownEditorVisibility(),this.updateNewContextButtonVisibility()})}renderContextsSelect(){const e=o.get("contexts"),t=o.get("selectedContext"),n='<option value="">Select context...</option>'+e.map(e=>'<option value="'.concat(e.name,'" data-color="').concat(e.color||"primary",'">').concat(e.name,"</option>")).join("");this.elements.contextSelect&&(this.elements.contextSelect.innerHTML=n,t&&(this.elements.contextSelect.value=t)),this.elements.mobileContextSelect&&(this.elements.mobileContextSelect.innerHTML=n,t&&(this.elements.mobileContextSelect.value=t)),this.updateContextIndicator()}updateContextIndicator(){if(this.elements.contextSelect&&this.elements.contextColorIndicator){const e=this.elements.contextSelect.options[this.elements.contextSelect.selectedIndex];if((null==e?void 0:e.dataset.color)&&""!==e.value){const t=y(e.dataset.color);this.elements.contextColorIndicator.style.background="var(--bulma-".concat(t,")"),this.elements.contextColorIndicator.style.opacity="1"}else this.elements.contextColorIndicator.style.background="var(--bulma-grey-light)",this.elements.contextColorIndicator.style.opacity="0.3"}if(this.elements.mobileContextSelect&&this.elements.mobileContextColorIndicator){const e=this.elements.mobileContextSelect.options[this.elements.mobileContextSelect.selectedIndex];if((null==e?void 0:e.dataset.color)&&""!==e.value){const t=y(e.dataset.color);this.elements.mobileContextColorIndicator.style.background="var(--bulma-".concat(t,")"),this.elements.mobileContextColorIndicator.style.opacity="1"}else this.elements.mobileContextColorIndicator.style.background="var(--bulma-grey-light)",this.elements.mobileContextColorIndicator.style.opacity="0.3"}}renderNotesList(){const e=o.get("notes"),t=o.get("selectedDate"),n=o.get("userSettings"),s=n.timezone||"UTC",i=n.dateFormat||"DD-MM-YY";if(!this.elements.notesList)return;if(0===e.length)return void(this.elements.notesList.innerHTML='<li class="has-text-centered py-6 has-text-grey-light">No notes yet</li>');const a=e.slice(0,this.renderedNotesCount),l=e.length>this.renderedNotesCount;this.elements.notesList.innerHTML=a.map(e=>{const[n,o,a]=e.date.split("-").map(Number),l=new Date(n,o-1,a).toLocaleDateString("en-US",{weekday:"long",timeZone:s}),c=String(n).substring(2),r=String(o).padStart(2,"0"),d=String(a).padStart(2,"0");let u;u="MM-DD-YY"===i?"".concat(r,"-").concat(d,"-").concat(c):"".concat(d,"-").concat(r,"-").concat(c);const m="".concat(l,", ").concat(u,".md"),h=e.date===t;return'\n                <li>\n                    <a\n                        class="'.concat(h?"is-active":"",'"\n                        data-date="').concat(e.date,'"\n                    >\n                        ').concat(m,"\n                    </a>\n                </li>\n            ")}).join(""),l&&(this.elements.notesList.innerHTML+='\n                <li class="has-text-centered py-3">\n                    <button class="button is-small is-ghost" id="load-more-notes" style="opacity: 0.7;">\n                        <span class="icon">\n                            <span class="material-symbols-outlined">expand_more</span>\n                        </span>\n                        <span>Load '.concat(Math.min(50,e.length-this.renderedNotesCount)," more</span>\n                    </button>\n                </li>\n            ")),this.elements.notesList.querySelectorAll("a[data-date]").forEach(e=>{e.addEventListener("click",async t=>{t.preventDefault();const n=e.dataset.date;if(n){if(o.get("selectedDate")===n)return void console.log("[UI] Date already selected, skipping:",n);await d.selectDate(n)}})});const c=document.getElementById("load-more-notes");c&&c.addEventListener("click",()=>{this.renderedNotesCount+=50,this.renderNotesList()})}updateEditorState(){const e=o.get("selectedContext"),t=o.get("contexts")||[];e?h.setDisabled(!1):h.ensureQuillLoaded().then(()=>{h.setDisabled(!0),h.setContent(""),0===t.length&&setTimeout(()=>{h.setPlaceholderMessage('Click "New Context" to create your first context and start writing notes.')},100)}),this.updateEditorDeleteButton()}updateEditorDeleteButton(){const e=document.getElementById("editor-delete-note-btn"),t=document.getElementById("editor-fullscreen-btn"),n=o.get("selectedContext"),s=o.get("selectedDate");n&&s?(e&&(e.style.display="flex"),t&&(t.style.display="flex")):(e&&(e.style.display="none"),t&&(t.style.display="none"))}updateSaveIndicator(e){this.elements.saveIndicator&&(this.elements.saveIndicator.className="save-indicator ".concat(e),"saved"===e?(this.elements.saveIndicator.textContent="Saved locally âœ“",setTimeout(()=>{this.elements.saveIndicator&&(this.elements.saveIndicator.textContent="")},2e3)):this.elements.saveIndicator.textContent="")}updateSyncStatus({pending:e,syncing:t}){this.elements.syncStatus&&this.elements.syncStatusText&&(e>0||t?(this.elements.syncStatus.style.display="flex",t?(this.elements.syncStatusText.textContent="Syncing ".concat(e," note").concat(1!==e?"s":"","..."),this.elements.syncStatus.classList.add("is-syncing"),this.elements.syncStatus.classList.remove("is-pending")):(this.elements.syncStatusText.textContent="".concat(e," note").concat(1!==e?"s":""," pending sync"),this.elements.syncStatus.classList.add("is-pending"),this.elements.syncStatus.classList.remove("is-syncing"))):setTimeout(()=>{this.elements.syncStatus&&(this.elements.syncStatus.style.display="none",this.elements.syncStatus.classList.remove("is-syncing","is-pending"))},1e3))}setTheme(e){document.documentElement.setAttribute("data-theme",e),this.elements.themeToggleSwitch&&(this.elements.themeToggleSwitch.checked="dark"===e),this.updateThemeIcon(),localStorage.setItem("theme",e)}updateThemeIcon(){var e;const t=document.documentElement.getAttribute("data-theme"),n=null==(e=this.elements.themeToggleMenu)?void 0:e.querySelector(".material-symbols-outlined");n&&(n.textContent="dark"===t?"light_mode":"dark_mode")}showApp(e=!1){if(console.log("[UI] showApp called"),console.log("[UI] authSection:",this.elements.authSection),console.log("[UI] appSection:",this.elements.appSection),!this.elements.authSection||!this.elements.appSection)return void console.error("[UI] Missing elements!");const t=document.getElementById("landing-loader");t&&(console.log("[UI] Hiding loader"),t.classList.remove("visible")),console.log("[UI] Hiding auth section"),this.elements.authSection.classList.remove("visible"),console.log("[UI] Showing app section"),this.elements.appSection.classList.add("visible"),console.log("[UI] App section display:",window.getComputedStyle(this.elements.appSection).display),this.updateContextSelectorVisibility(),this.updateBreadcrumbVisibility(),this.updateMarkdownEditorVisibility(),this.updateNewContextButtonVisibility(),this.updateEditorState(),this.startClock();const n=o.get("hasNoContexts");console.log("[UI] showApp - hasNoContexts:",n),n?(console.log("[UI] Showing onboarding modal"),setTimeout(()=>{var e;null==(e=this.elements.onboardingModal)||e.classList.add("is-active")},500)):console.log("[UI] NOT showing onboarding modal")}hideApp(){this.elements.authSection&&this.elements.appSection&&(this.elements.appSection.classList.remove("visible"),this.elements.authSection.classList.add("visible"))}showError(e,t={}){let n="Error",o=7e3,s="";"object"==typeof e?(n=e.title||"Error",s=e.message||"An error occurred",o=e.duration||7e3):s=e,(s.includes("network")||s.includes("offline"))&&(n="Connection Error",o=1e4),g.error(s,{title:n,duration:o,...t})}showSuccess(e,t={}){g.success(e,{duration:3e3,...t})}showWarning(e,t={}){g.warning(e,{duration:5e3,...t})}showInfo(e,t={}){g.info(e,{duration:4e3,...t})}showContextModal(){var e;null==(e=this.elements.contextModal)||e.classList.add("is-active");const t=document.getElementById("context-name"),n=document.getElementById("context-color");t&&(t.value=""),n&&(n.value="primary"),function(e,t){const n=document.getElementById(e),o=document.querySelectorAll("#".concat(t," .color-btn"));if(!o.length)return;o.forEach(e=>{const t=e.cloneNode(!0),n=e.parentNode;n&&n.replaceChild(t,e)}),document.querySelectorAll("#".concat(t," .color-btn")).forEach(e=>{e.addEventListener("click",o=>{o.preventDefault();const s=e.dataset.color;n&&s&&(n.value=s),document.querySelectorAll("#".concat(t," .color-btn")).forEach(e=>{const t=e;t.classList.remove("is-active"),t.style.border="3px solid transparent",t.style.borderRadius="8px"});const i=e;i.classList.add("is-active"),i.style.border="3px solid var(--bulma-text)",i.style.borderRadius="8px"})})}("context-color","context-color-buttons"),function(e,t,n){const o=document.querySelectorAll("#".concat(t," .color-btn")),s=document.getElementById(n);s&&(s.value=e),o.forEach(t=>{const n=t;n.classList.remove("is-active"),n.style.border="3px solid transparent",n.style.borderRadius="8px",n.dataset.color===e&&(n.classList.add("is-active"),n.style.border="3px solid var(--bulma-text)",n.style.borderRadius="8px")})}("primary","context-color-buttons","context-color"),null==t||t.focus()}closeContextModal(){var e;null==(e=this.elements.contextModal)||e.classList.remove("is-active")}showSettingsModal(){var e;const t=o.get("userSettings");this.elements.weekStartSelect&&(this.elements.weekStartSelect.value=String(t.weekStart)),this.elements.timezoneSelect&&(this.elements.timezoneSelect.value=t.timezone);const n=document.getElementById("date-format-select");n&&(n.value=t.dateFormat||"DD-MM-YY");const s=document.getElementById("unique-context-mode-switch");s&&(s.checked=t.uniqueContextMode||!1);const i=document.getElementById("show-breadcrumb-switch");i&&(i.checked=!0===t.showBreadcrumb);const a=document.getElementById("show-markdown-editor-switch");a&&(a.checked=!0===t.showMarkdownEditor);const l=document.getElementById("hide-new-context-button-switch");l&&(l.checked=!0===t.hideNewContextButton);const c=document.getElementById("contexts-accordion-content"),r=document.getElementById("contexts-accordion-icon");if(c&&(c.style.display="none",c.style.opacity="1"),r){const e=r.querySelector(".material-symbols-outlined");e&&(e.textContent="expand_more")}this.renderContextsEditList();const d=document.getElementById("settings-save-btn"),u=document.getElementById("settings-save-icon"),m=document.getElementById("settings-save-spinner"),h=document.getElementById("settings-save-text");if(d&&(d.disabled=!1),u){u.style.display="inline-flex";const e=u.querySelector(".material-symbols-outlined");e&&(e.textContent="check")}m&&(m.style.display="none"),h&&(h.textContent="Save"),null==(e=this.elements.settingsModal)||e.classList.add("is-active")}closeSettingsModal(){var e;const t=document.getElementById("contexts-accordion-content"),n=document.getElementById("contexts-accordion-icon");if(t&&(t.style.display="none",t.style.opacity="1"),n){const e=n.querySelector(".material-symbols-outlined");e&&(e.textContent="expand_more")}null==(e=this.elements.settingsModal)||e.classList.remove("is-active")}closeOnboardingModal(){var e;null==(e=this.elements.onboardingModal)||e.classList.remove("is-active")}showDeleteNoteModal(e,t,n){const o=document.getElementById("delete-note-modal"),s=document.getElementById("delete-note-message");o&&s&&(o.dataset.context=e,o.dataset.date=t,s.textContent="Are you sure you want to delete the note for ".concat(n,"?"),o.classList.add("is-active"))}closeDeleteNoteModal(){const e=document.getElementById("delete-note-modal");e&&(e.classList.remove("is-active"),delete e.dataset.context,delete e.dataset.date)}closeAllModals(){this.closeContextModal(),this.closeSettingsModal(),this.closeOnboardingModal(),this.closeDeleteNoteModal()}startClock(){this.clockStarted?console.log("[UI] Clock already started, skipping"):(this.clockStarted=!0,console.log("[UI] Starting clock with server time sync"),this.updateCurrentDateTime(),setInterval(()=>this.updateCurrentDateTime(),1e3))}updateCurrentDateTime(){var e;const t=o.get("userSettings"),n=t.timezone||"UTC",s=t.dateFormat||"DD-MM-YY",i=o.get("serverTimeOffset"),a=new Date(Date.now()+i);let l;l="MM-DD-YY"===s?"en-US":navigator.language||(null==(e=navigator.languages)?void 0:e[0])||"en-GB";const c={hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1,timeZone:n},r={weekday:"long",year:"numeric",month:"long",day:"numeric",timeZone:n},d=a.toLocaleTimeString(l,c),u=a.toLocaleDateString(l,r);this.elements.currentTime&&(this.elements.currentTime.textContent=d),this.elements.currentDate&&(this.elements.currentDate.textContent=u);const h={year:"numeric",month:"long",day:"numeric",timeZone:n},g=a.toLocaleDateString(l,h);this.elements.mobileCurrentTime&&(this.elements.mobileCurrentTime.textContent=d),this.elements.mobileCurrentDate&&(this.elements.mobileCurrentDate.textContent=g);const y=o.get("today");this.lastKnownDate&&this.lastKnownDate!==y&&m.render(),this.lastKnownDate=y}updateDatePickerDisplay(e){const t=document.getElementById("date-picker-display");if(!t||!e)return;const n=o.get("userSettings").dateFormat||"DD-MM-YY",[s,i,a]=e.split("-").map(Number),l=String(s).substring(2),c=String(i).padStart(2,"0"),r=String(a).padStart(2,"0");let d;d="MM-DD-YY"===n?"".concat(c,"/").concat(r,"/").concat(l):"".concat(r,"/").concat(c,"/").concat(l),t.textContent=d}updateContextSelectorVisibility(){const e=o.get("userSettings").uniqueContextMode||!1,t=document.getElementById("desktop-context-selector"),n=document.getElementById("mobile-context-selector");e?(t&&(t.style.display="none"),n&&(n.style.display="none")):(t&&(t.style.display=""),n&&(n.style.display=""))}updateBreadcrumbVisibility(){const e=!0===o.get("userSettings").showBreadcrumb,t=document.getElementById("drive-breadcrumb"),n=document.querySelector(".main-section");t&&(t.style.display=e?"":"none"),n&&(e?n.removeAttribute("data-hide-breadcrumb"):n.setAttribute("data-hide-breadcrumb","true"))}updateMarkdownEditorVisibility(){const e=!0===o.get("userSettings").showMarkdownEditor,t=document.querySelector(".ql-toolbar");t&&(t.style.display=e?"":"none");const n=o.get("selectedContext");h.setDisabled(!n)}updateNewContextButtonVisibility(){const e=!0===o.get("userSettings").hideNewContextButton,t=document.getElementById("desktop-new-context-btn"),n=document.getElementById("mobile-new-context-btn");t&&(t.style.display=e?"none":""),n&&(n.style.display=e?"none":"")}renderContextsEditList(){const e=o.get("contexts"),t=document.getElementById("contexts-edit-list");t&&(0!==e.length?t.innerHTML=e.map((e,t)=>{const n=y(e.color);return'\n            <div class="is-flex is-align-items-center is-justify-content-space-between mb-3"\n                 style="padding: 0.75rem 1rem; background: var(--bulma-scheme-main-bis); border-left: 3px solid var(--bulma-'.concat(n,'); border-radius: 6px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">\n                <div class="is-flex is-align-items-center" style="gap: 0.75rem; flex: 1; min-width: 0;">\n                    <span style="display: block; width: 12px; height: 12px; background: var(--bulma-').concat(n,'); border-radius: 50%; flex-shrink: 0;"></span>\n                    <span style="font-size: 0.9rem; font-weight: 500; color: var(--bulma-text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">').concat(e.name,'</span>\n                </div>\n                <div class="is-flex is-align-items-center" style="gap: 0.35rem;">\n                    <button class="button is-small context-action-btn context-edit-btn"\n                            onclick="window.showEditContextModal(\'').concat(e.id,'\')"\n                            title="Edit context"\n                            style="padding: 0.35rem; border: none; background: transparent; border-radius: 50%; width: 32px; height: 32px;">\n                        <span class="icon is-small">\n                            <span class="material-symbols-outlined" style="font-size: 18px; color: var(--bulma-grey);">edit</span>\n                        </span>\n                    </button>\n                    <button class="button is-small context-action-btn context-delete-btn"\n                            onclick="window.showDeleteContextModal(\'').concat(e.id,"', '").concat(e.name.replace(/'/g,"\\'"),'\')"\n                            title="Delete context"\n                            style="padding: 0.35rem; border: none; background: transparent; border-radius: 50%; width: 32px; height: 32px;">\n                        <span class="icon is-small">\n                            <span class="material-symbols-outlined" style="font-size: 18px; color: var(--bulma-grey);">delete</span>\n                        </span>\n                    </button>\n                </div>\n            </div>\n        ')}).join(""):t.innerHTML='<p class="has-text-centered has-text-grey-light py-5">No contexts yet. Create your first context to get started!</p>')}setupMobileNavigation(){var e,t,n,o,s,i;null==(e=this.elements.mobileNotesToggle)||e.addEventListener("click",()=>{this.toggleMobileSidebar()}),null==(t=this.elements.mobileCalendarToggle)||t.addEventListener("click",()=>{this.toggleMobileCalendar()}),null==(n=this.elements.sidebarClose)||n.addEventListener("click",()=>{this.closeMobileSidebar()}),null==(o=this.elements.calendarClose)||o.addEventListener("click",()=>{this.closeMobileCalendar()}),null==(s=this.elements.sidebarOverlay)||s.addEventListener("click",()=>{this.closeMobileSidebar()}),null==(i=this.elements.calendarOverlay)||i.addEventListener("click",()=>{this.closeMobileCalendar()}),this.elements.notesList&&this.elements.notesList.addEventListener("click",e=>{"A"===e.target.tagName&&window.innerWidth<=768&&this.closeMobileSidebar()}),window.addEventListener("resize",()=>{window.innerWidth>768&&(this.elements.sidebar&&(this.elements.sidebar.classList.remove("mobile-panel","active"),this.elements.sidebar.style.display=""),this.elements.calendarPanel&&(this.elements.calendarPanel.classList.remove("mobile-panel","active"),this.elements.calendarPanel.style.display=""),this.elements.sidebarOverlay&&this.elements.sidebarOverlay.classList.remove("active"),this.elements.calendarOverlay&&this.elements.calendarOverlay.classList.remove("active"),document.body.style.overflow="")})}toggleMobileSidebar(){if(!this.elements.sidebar||!this.elements.sidebarOverlay)return;if(window.innerWidth>768)return;this.elements.sidebar.classList.contains("mobile-panel")||(this.elements.sidebar.classList.add("mobile-panel"),this.elements.sidebar.style.display="flex"),this.elements.sidebar.classList.toggle("active"),this.elements.sidebarOverlay.classList.toggle("active"),this.elements.sidebar.classList.contains("active")?document.body.style.overflow="hidden":document.body.style.overflow=""}closeMobileSidebar(){this.elements.sidebar&&this.elements.sidebarOverlay&&(this.elements.sidebar.classList.remove("active"),this.elements.sidebarOverlay.classList.remove("active"),document.body.style.overflow="")}toggleMobileCalendar(){if(!this.elements.calendarPanel||!this.elements.calendarOverlay)return;if(window.innerWidth>768)return;this.elements.calendarPanel.classList.contains("mobile-panel")||(this.elements.calendarPanel.classList.add("mobile-panel"),this.elements.calendarPanel.style.display="flex"),this.elements.calendarPanel.classList.toggle("active"),this.elements.calendarOverlay.classList.toggle("active"),this.elements.calendarPanel.classList.contains("active")?document.body.style.overflow="hidden":document.body.style.overflow=""}closeMobileCalendar(){this.elements.calendarPanel&&this.elements.calendarOverlay&&(this.elements.calendarPanel.classList.remove("active"),this.elements.calendarOverlay.classList.remove("active"),document.body.style.overflow="")}updateBreadcrumb(){const e=o.get("selectedContext"),t=o.get("selectedDate"),n=o.get("userSettings"),s=n.timezone||"UTC",i=n.dateFormat||"DD-MM-YY";if(this.elements.breadcrumbContextName&&e&&(this.elements.breadcrumbContextName.textContent=e),this.elements.breadcrumbDateName&&t){const[e,n,o]=t.split("-").map(Number),a=new Date(e,n-1,o).toLocaleDateString("en-US",{weekday:"long",timeZone:s}),l=String(e).substring(2),c=String(n).padStart(2,"0"),r=String(o).padStart(2,"0");let d;d="MM-DD-YY"===i?"".concat(c,"-").concat(r,"-").concat(l):"".concat(r,"-").concat(c,"-").concat(l);const u="".concat(a,", ").concat(d,".md");this.elements.breadcrumbDateName.textContent=u,this.elements.mobileSelectedNoteDate&&(this.elements.mobileSelectedNoteDate.textContent="".concat(d,".md"))}}openFullscreenNote(){const e=o.get("selectedContext"),t=o.get("selectedDate");if(!e||!t)return;const n=o.get("userSettings"),s=n.timezone||"UTC",i=n.dateFormat||"DD-MM-YY",[a,l,c]=t.split("-").map(Number),r=new Date(a,l-1,c).toLocaleDateString("en-US",{weekday:"long",timeZone:s}),d=String(a).substring(2),u=String(l).padStart(2,"0"),m=String(c).padStart(2,"0");let g;g="MM-DD-YY"===i?"".concat(u,"-").concat(m,"-").concat(d):"".concat(m,"-").concat(u,"-").concat(d);const y="".concat(r,", ").concat(g,".md"),p=document.getElementById("fullscreen-note-modal"),w=document.getElementById("fullscreen-note-date"),x=document.getElementById("fullscreen-note-editor");if(!p||!w||!x)return;w.textContent=y;const v=h.getContent();if(window.Quill){x.innerHTML="";const e=new window.Quill(x,{theme:"snow",readOnly:!0,modules:{toolbar:!1}});e.root.innerHTML=v,e.root.style.fontSize="16px",e.root.style.lineHeight="1.6"}else x.innerHTML=v;p.classList.add("is-active");const b=e=>{"Escape"===e.key&&(this.closeFullscreenNote(),document.removeEventListener("keydown",b))};document.addEventListener("keydown",b)}closeFullscreenNote(){const e=document.getElementById("fullscreen-note-modal");e&&e.classList.remove("is-active")}};"undefined"!=typeof window&&(window.ui=p,window.showNewContextModal=()=>p.showContextModal(),window.closeContextModal=()=>p.closeContextModal(),window.createContext=async()=>{const e=document.getElementById("context-name"),t=document.getElementById("context-color"),n=null==e?void 0:e.value.trim(),s=null==t?void 0:t.value;if(!n)return;await u.createContext(n,s),p.closeContextModal(),await d.loadNotesList(n);const i=o.get("selectedDate");i&&await d.loadNote(n,i)},window.showSettingsModal=()=>p.showSettingsModal(),window.closeSettingsModal=()=>p.closeSettingsModal(),window.saveSettings=async()=>{const e=document.getElementById("settings-save-btn"),t=document.getElementById("settings-save-icon"),n=document.getElementById("settings-save-spinner"),s=document.getElementById("settings-save-text"),i=document.getElementById("settings-cancel-btn"),a=document.getElementById("week-start-select"),l=document.getElementById("timezone-select"),r=document.getElementById("date-format-select"),h=document.getElementById("unique-context-mode-switch"),y=document.getElementById("show-breadcrumb-switch"),w=document.getElementById("show-markdown-editor-switch"),x=document.getElementById("hide-new-context-button-switch"),v=o.get("userSettings"),b=parseInt((null==a?void 0:a.value)||"0"),C=(null==l?void 0:l.value)||"UTC",S=(null==r?void 0:r.value)||"DD-MM-YY",f=(null==h?void 0:h.checked)||!1,E=!0===(null==y?void 0:y.checked),I=!0===(null==w?void 0:w.checked),N=!0===(null==x?void 0:x.checked),k=v.theme||"dark";e&&(e.disabled=!0),i&&(i.disabled=!0),t&&(t.style.display="none"),n&&(n.style.display="inline-block"),s&&(s.textContent="Saving...");try{if(await c.updateSettings({theme:k,weekStart:b,timezone:C,dateFormat:S,uniqueContextMode:f,showBreadcrumb:E,showMarkdownEditor:I,hideNewContextButton:N}),o.set("userSettings",{theme:k,weekStart:b,timezone:C,dateFormat:S,uniqueContextMode:f,showBreadcrumb:E,showMarkdownEditor:I,hideNewContextButton:N}),m.render(),s&&(s.textContent="Saved!"),n&&(n.style.display="none"),t){t.style.display="inline-flex";const e=t.querySelector(".material-symbols-outlined");e&&(e.textContent="check_circle")}if(await new Promise(e=>setTimeout(e,500)),p.closeSettingsModal(),p.renderNotesList(),p.updateContextSelectorVisibility(),p.updateBreadcrumbVisibility(),p.updateMarkdownEditorVisibility(),p.updateNewContextButtonVisibility(),f){const e=o.get("contexts");e&&e.length>0&&(u.selectContext(e[0].name),d.setTodayDate(),d.loadNotesList(e[0].name))}}catch(T){if(console.error("Failed to save settings:",T),g.error("Failed to save settings"),s&&(s.textContent="Save"),n&&(n.style.display="none"),t){t.style.display="inline-flex";const e=t.querySelector(".material-symbols-outlined");e&&(e.textContent="check")}}finally{e&&(e.disabled=!1),i&&(i.disabled=!1)}},window.closeOnboardingModal=()=>p.closeOnboardingModal(),window.closeDeleteNoteModal=()=>p.closeDeleteNoteModal(),window.confirmDeleteNote=async()=>{const e=document.getElementById("delete-note-modal");if(!e)return;const t=e.dataset.context,n=e.dataset.date;t&&n&&(p.closeDeleteNoteModal(),await d.deleteNote(t,n))},window.showEditContextModal=e=>{const t=o.get("contexts").find(t=>t.id===e);if(!t)return;const n=document.getElementById("edit-context-modal"),s=document.getElementById("edit-context-name"),i=document.getElementById("edit-context-color-value"),a=document.getElementById("edit-context-colors");if(!(n&&s&&i&&a))return;s.value=t.name;const l=y(t.color);i.value=l;a.innerHTML=["text","link","primary","info","success","warning","danger"].map(e=>{const t=l===e,n=t?"border: 3px solid var(--bulma-text)":"border: 3px solid transparent";return'\n                <button type="button" class="button color-btn '.concat(t?"is-active":"",'"\n                        data-color="').concat(e,'"\n                        onclick="window.selectEditContextColor(\'').concat(e,'\')"\n                        title="').concat(function(e){return{text:"Text (Gray)",link:"Link (Blue)",primary:"Primary (Cyan)",info:"Info (Light Blue)",success:"Success (Green)",warning:"Warning (Yellow)",danger:"Danger (Red)"}[e]||e}(e),'"\n                        style="width: 32px; height: 32px; padding: 3px; ').concat(n,'; border-radius: 6px;">\n                    <span style="display: block; width: 100%; height: 100%; background: var(--bulma-').concat(e,'); border-radius: 4px;"></span>\n                </button>\n            ')}).join(""),n.dataset.contextId=e,n.classList.add("is-active")},window.selectEditContextColor=e=>{const t=document.getElementById("edit-context-color-value");if(!t)return;t.value=e;document.querySelectorAll("#edit-context-colors .color-btn").forEach(t=>{t.dataset.color===e?(t.classList.add("is-active"),t.style.border="3px solid var(--bulma-text)"):(t.classList.remove("is-active"),t.style.border="3px solid transparent")})},window.closeEditContextModal=()=>{const e=document.getElementById("edit-context-modal");e&&(e.classList.remove("is-active"),delete e.dataset.contextId)},window.confirmEditContext=async()=>{const e=document.getElementById("edit-context-modal");if(!e)return;const t=e.dataset.contextId,n=document.getElementById("edit-context-name"),o=document.getElementById("edit-context-color-value");if(!t||!n||!o)return;const s=n.value.trim(),i=o.value;s?(window.closeEditContextModal(),await u.updateContext(t,s,i),p.renderContextsEditList(),p.renderContextsSelect()):alert("Please enter a context name")},window.showDeleteContextModal=(e,t)=>{const n=document.getElementById("delete-context-modal"),o=document.getElementById("delete-context-name");n&&o&&(o.textContent=t,n.dataset.contextId=e,n.classList.add("is-active"))},window.closeDeleteContextModal=()=>{const e=document.getElementById("delete-context-modal");e&&(e.classList.remove("is-active"),delete e.dataset.contextId)},window.confirmDeleteContext=async()=>{const e=document.getElementById("delete-context-modal");if(!e)return;const t=e.dataset.contextId;t&&(window.closeDeleteContextModal(),await u.deleteContext(t),p.renderContextsEditList(),p.renderContextsSelect())});const w=new class{constructor(){t(this,"syncQueue",null)}async init(e){console.log("[MAIN] Initializing with client ID:",e);try{await a.init(),console.log("Cache initialized")}catch(t){console.warn("IndexedDB not available",t)}this.syncQueue=new l(c),this.setupEventHandlers(),p.init(),await h.init("markdown-editor-container",e=>{d.handleNoteInput(e)});if(await r.checkAuth())await this.showApp();else{const e=document.getElementById("app-section"),t=document.getElementById("auth-section");e&&e.classList.remove("visible"),t&&t.classList.add("visible")}document.body.classList.add("loaded"),r.initGoogleClient(e).catch(e=>{console.error("[MAIN] Failed to initialize Google client:",e)})}setupEventHandlers(){s.on("sync-add",e=>{var t;null==(t=this.syncQueue)||t.add(e.detail)}),s.on("sync-force",()=>{this.syncQueue&&this.syncQueue.getPendingCount()>0&&this.syncQueue.process()}),s.on(i.SYNC_STATUS,e=>{p.updateSyncStatus(e.detail)}),s.on(i.OPERATION_SYNCED,e=>{console.log("Synced to server:",e.detail.type)}),s.on(i.SYNC_ERROR,e=>{const{error:t,maxRetriesReached:n,retryCount:o,maxRetries:s}=e.detail;n?g.error("Failed to sync note after multiple attempts. Please check your connection.",{title:"Sync Failed",duration:5e3}):o&&console.warn("Sync retry ".concat(o,"/").concat(s,":"),t)}),s.on("session-expired",e=>{e.detail.isNoteRequest&&g.warning("Session expired. Your notes are saved locally and will sync when you sign in again.",{title:"Session Expired",duration:1e4})}),s.on(i.NOTE_LOADED,e=>{h.setContent(e.detail.content)}),s.on(i.NOTE_SAVED,()=>{console.log("[Note] Saved")}),s.on(i.CONTEXT_CHANGED,async e=>{const t=e.detail.context;if(h.forceFlush(),await new Promise(e=>setTimeout(e,100)),t){let e=o.get("selectedDate");e||(e=o.get("today")),await d.loadNotesList(t),m.render(),e&&(d.ensureNoteInList(t,e),await d.loadNote(t,e))}else h.setContent("")}),s.on(i.DATE_CHANGED,async e=>{const t=e.detail.date,n=o.get("selectedContext");if(h.forceFlush(),await new Promise(e=>setTimeout(e,100)),n){const e=o.get("selectedContext"),s=o.get("selectedDate");if(e!==n||s!==t)return void console.log("[MAIN] Context/date changed during handler, skipping");await d.loadNote(n,t)}}),s.on("auth-success",async()=>{await this.showApp()}),s.on("auth-logout",()=>{h.setContent("")}),s.on(i.SHOW_ERROR,e=>{e.detail.message&&g.error(e.detail.message)}),s.on(i.SHOW_SUCCESS,e=>{e.detail.message&&g.success(e.detail.message)})}async showApp(){console.log("[MAIN] showApp called");try{console.log("[MAIN] Loading contexts..."),await u.loadContexts(),await this.syncServerTime(),d.setTodayDate(),m.render();const e=u.restoreLastContext();if(console.log("[MAIN] Last context:",e),e){await d.loadNotesList(e);const t=o.get("today");d.ensureNoteInList(e,t),await d.loadNote(e,t)}p.showApp(),console.log("[MAIN] App initialization complete")}catch(e){console.error("[MAIN] Error initializing app:",e),g.error("Failed to initialize app. Please refresh the page.",{title:"Initialization Error",duration:0})}}async syncServerTime(){try{const e=o.get("userSettings").timezone||"UTC",t=Date.now(),n=1e3*((await c.getServerTime(e)).timestamp||0),s=n-t+(Date.now()-t)/2;console.log("[MAIN] Server time synced. Offset:",s,"ms"),o.set("serverTimeOffset",s)}catch(e){console.error("Failed to sync server time:",e),o.set("serverTimeOffset",0)}setTimeout(()=>this.syncServerTime(),6e4)}};window.__APP__=w,"undefined"!=typeof window&&"localhost"===window.location.hostname&&(window.__DEBUG__={app:w,state:o,events:s,notes:d,contexts:u,calendar:m,auth:r,api:c,cache:a,markdownEditor:h,notifications:g,ui:p},console.log("Debug mode enabled. Access modules via window.__DEBUG__")),(async()=>{await new Promise(e=>setTimeout(e,0));const e=document.querySelector('meta[name="google-client-id"]'),t=(null==e?void 0:e.getAttribute("content"))||window.__GOOGLE_CLIENT_ID__;t?await w.init(t):console.error("Google Client ID not found")})();export{n as __vite_legacy_guard};
//# sourceMappingURL=main-BDlIns60.js.map
